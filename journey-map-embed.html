<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統合ジャーニーマップビューア</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            background-color: transparent;
            margin: 0;
            padding: 16px;
        }
        
        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* D3グラフ用スタイル */
        .tooltip {
            position: absolute;
            text-align: left;
            padding: 12px;
            font-size: 14px;
            background: #1f2937;
            color: #f9fafb;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        .tooltip .event {
            font-weight: 700;
            margin-bottom: 4px;
            color: #93c5fd;
        }
        .axis-label {
            font-size: 12px;
            fill: #4b5563;
        }
        .domain {
            stroke: #d1d5db;
        }
        .tick line {
            stroke: #e5e7eb;
        }
        .tick text {
            fill: #6b7280;
            font-size: 12px;
        }
        .grid-line {
            stroke: #e5e7eb;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        
        /* アニメーション */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease-out;
        }
        
        /* ジャーニーカード */
        .journey-card {
            transition: all 0.2s ease;
        }
        .journey-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* 比較モード用レイアウト */
        .comparison-grid {
            display: grid;
            gap: 1rem;
            height: 100%;
        }
        .comparison-grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        .comparison-grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        .comparison-grid-4 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }
        
        @media (max-width: 768px) {
            .comparison-grid-2,
            .comparison-grid-3,
            .comparison-grid-4 {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // データ整合性チェック関数
        const validatePersonaData = () => {
            const errors = [];
            Object.entries(personaData).forEach(([id, persona]) => {
                if (!persona.name) errors.push(`${id}: 名前が設定されていません`);
                if (!persona.color) errors.push(`${id}: カラーが設定されていません`);
                if (!persona.detailJourney) errors.push(`${id}: detailJourneyが設定されていません`);
                if (!persona.selfAuthorshipJourney) errors.push(`${id}: selfAuthorshipJourneyが設定されていません`);
                
                // detailJourneyの検証
                if (persona.detailJourney) {
                    ['growth', 'stagnation'].forEach(type => {
                        if (!persona.detailJourney[type] || !Array.isArray(persona.detailJourney[type])) {
                            errors.push(`${id}: detailJourney.${type}が配列ではありません`);
                        }
                    });
                }
                
                // selfAuthorshipJourneyの検証
                if (persona.selfAuthorshipJourney) {
                    ['growth', 'stagnation'].forEach(type => {
                        if (!persona.selfAuthorshipJourney[type] || !Array.isArray(persona.selfAuthorshipJourney[type])) {
                            errors.push(`${id}: selfAuthorshipJourney.${type}が配列ではありません`);
                        }
                    });
                }
            });
            
            if (errors.length > 0) {
                console.warn('データ整合性チェックで問題が発見されました:', errors);
            } else {
                console.log('データ整合性チェック: 問題なし');
            }
            
            return errors;
        };
        
        // ペルソナデータの定義
        const personaData = {
            nishimura: {
                name: "西村悠真",
                description: "明るく社交的で、ノリで動くタイプ。楽観的だが、責任感に欠ける面がある。",
                color: "#14b8a6",
                detailJourney: {
                    growth: [
                        { time: "1年4月", event: "入学。特に深く考えず、親の勧めで経済学部に。すぐにサークルの新歓コンパで人気者になる。", emotion: "「大学、ちょろいな！」と楽観的に考える。友達がたくさんできて楽しい。" },
                        { time: "1年6月", event: "バイト先の先輩に「将来何したいの？」と聞かれ、言葉に詰まる。", emotion: "初めて将来のことを問われ、モヤモヤする。楽しい今が続けばいいと思っている自分に気づく。" },
                        { time: "2年7月", event: "期末試験。1年の時より範囲が広く、一夜漬けが通用しなくなってくる。", emotion: "さすがに焦りを感じる。「これはまずい」と思う。" },
                        { time: "3年5月", event: "ゼミでグループプロジェクトが始まる。場の雰囲気で、リーダーに推薦されてしまう。", emotion: "「まあ、いっか」と、深く考えずに引き受ける。" },
                        { time: "3年9月", event: "夏休み明け、プロジェクトが完全に停滞。メンバーのやる気もなく、険悪な雰囲気に。", emotion: "「なんか雰囲気悪いな」「面倒なことになった」と、問題から目をそらす。", isTurningPoint: true },
                        { time: "3年10月", event: "メンバーの一人から「リーダーとしてどう考えてるの？本気でやってよ」と真剣に問われる。", emotion: "初めての経験に衝撃を受け、何も言い返せない。悔しさと情けなさでいっぱいになる。（強い不協和）" },
                        { time: "3年11月", event: "プロジェクトを投げ出したい気持ちになるが、初めて本気で悩む。思い切ってゼミの教員に相談する。", emotion: "恥ずかしいが、藁にもすがる思い。" },
                        { time: "3年12月", event: "教員のアドバイスを受け、メンバー一人ひとりと面談。「悪かった」と謝罪し、本音で話す。", emotion: "非常に勇気がいる行動。断られるかもしれないと怖いが、逃げないと決める。" },
                        { time: "3年1月", event: "チームが再始動。自分が率先して泥臭い作業も引き受け、メンバーをまとめる。", emotion: "大変だが、チームが一つになっていくことに、これまでにない充実感と喜びを感じる。" },
                        { time: "3年2月", event: "プロジェクト発表。完璧ではなかったが、やりきった達成感で胸がいっぱいになる。", emotion: "チームで困難を乗り越えた経験が、大きな自信になる。" },
                        { time: "4年4月", event: "ベンチャー企業のインターンシップに参加。社員たちが本気で議論し、協力する姿に惹かれる。", emotion: "「ここだ！」と直感する。ゼミでの経験が重なる。" },
                        { time: "4年5月", event: "そのベンチャー企業から内定を得て、就職活動を終了する。", emotion: "親は心配するが、自分の言葉で「なぜこの会社なのか」を熱意をもって説明する。" },
                        { time: "4年3月", event: "卒業式。ゼミの仲間や教員、サークルの友人たちと、別れを惜しむ。", emotion: "感謝の気持ちでいっぱい。みんなとの出会いが自分を成長させてくれたと感じる。" }
                    ],
                    stagnation: [
                        { time: "1年4月", event: "入学。特に深く考えず、親の勧めで経済学部に。すぐにサークルの新歓コンパで人気者になる。", emotion: "「大学、ちょろいな！」と楽観的に考える。友達がたくさんできて楽しい。" },
                        { time: "2年9月", event: "ゼミ選択の時期。楽だと評判のゼミに、友人と一緒に応募することを決める。", emotion: "「ゼミは楽なのが一番」と考える。" },
                        { time: "3年5月", event: "ゼミでグループプロジェクトが始まる。場の雰囲気で、リーダーに推薦されてしまう。", emotion: "「まあ、いっか」と、深く考えずに引き受ける。" },
                        { time: "3年9月", event: "夏休み明け、プロジェクトが完全に停滞。メンバーのやる気もなく、険悪な雰囲気に。", emotion: "「なんか雰囲気悪いな」「面倒なことになった」と、問題から目をそらす。", isTurningPoint: true },
                        { time: "3年10月", event: "メンバーの一人から「リーダーとしてどう考えてるの？本気でやってよ」と真剣に問われる。", emotion: "「そんなこと言われても…」と逆ギレしそうになる。「俺一人のせいじゃないだろ」と心の中で反発する。" },
                        { time: "3年11月", event: "プロジェクトの集まりに行かなくなり、リーダーの役割を事実上放棄する。", emotion: "「あんな奴らとやってられない」「リーダーなんて向いてない」と開き直る。" },
                        { time: "3年12月", event: "プロジェクトは空中分解し、発表は散々な結果に終わる。", emotion: "「俺のせいじゃない」と最後まで思う。メンバーに対して嫌悪感すら抱く。" },
                        { time: "4年1月", event: "就職活動もうまくいかず、面接で自己PRに詰まる。", emotion: "「どうせ俺なんて」と、やる気を失う。" },
                        { time: "4年3月", event: "投げやりな気持ちで受けた、雰囲気がゆるそうな中小企業から内定が出る。", emotion: "「どこでもいいや」と、深く考えずに承諾する。" },
                        { time: "4年3月", event: "卒業式。気まずいゼミの仲間とは距離を置き、サークルの友人とだけ写真を撮る。", emotion: "ほろ苦い気持ち。4年間で一体何が残ったのか、分からなくなる。" }
                    ]
                },
                selfAuthorshipJourney: {
                    growth: [
                        { time: 1.2, stage: 1.0, event: "入学、サークルで人気者に", emotion: "「大学、ちょろいな！」と楽観的。友達がたくさんできて楽しい。" },
                        { time: 1.4, stage: 1.1, event: "バイト先の先輩に将来を聞かれ、言葉に詰まる", emotion: "初めて将来のことを問われモヤモヤするが、すぐに忘れる。（小さな不協和）" },
                        { time: 1.5, stage: 1.0, event: "モヤモヤした気持ちを友人たちとの飲み会で忘れる", emotion: "深く考えるのをやめ、今が楽しければいいやと思い直す。" },
                        { time: 2.0, stage: 1.1, event: "2年生になり、少し専門的な授業が増える", emotion: "授業が難しくなってきたが、まだ何とかなると楽観視。" },
                        { time: 2.5, stage: 1.0, event: "一夜漬けが通用しなくなり、焦る", emotion: "「これはまずい」と、これまでのやり方が通用しない現実に直面する。" },
                        { time: 2.6, stage: 1.1, event: "友人に助けられて何とか試験をクリア", emotion: "危機は脱したが、根本的な解決はしていない不安が残る。" },
                        { time: 3.0, stage: 1.2, event: "3年生になり、ゼミ選択や就活を意識し始める", emotion: "周りが真剣になっているのを見て、少し焦りを感じる。" },
                        { time: 3.4, stage: 1.2, event: "場の雰囲気でゼミのリーダーを引き受ける", emotion: "「まあ、いっか」と深く考えずに引き受ける。他者からの期待に流される。" },
                        { time: 3.6, stage: 1.3, event: "リーダーとしての責任を感じ始める", emotion: "最初は軽く考えていたが、段々とプレッシャーを感じるように。" },
                        { time: 3.7, stage: 1.5, event: "【分岐点】プロジェクトが停滞し、雰囲気が険悪に", emotion: "「面倒なことになった」と問題から目をそらす。責任から逃げたい。" },
                        { time: 3.75, stage: 1.3, event: "チームの雰囲気の悪化に困惑する", emotion: "どうしていいか分からず、混乱と不安で頭がいっぱいになる。" },
                        { time: 3.8, stage: 1.8, event: "メンバーから真剣に問われ、衝撃を受ける", emotion: "初めての経験に何も言い返せず、悔しさと情けなさでいっぱいになる。（強い不協和）" },
                        { time: 3.85, stage: 1.6, event: "一人になって、今まで避けてきた現実と向き合う", emotion: "逃げたい気持ちと、このままではダメだという気持ちが交錯する。" },
                        { time: 3.9, stage: 2.0, event: "初めて本気で悩み、教員に相談する", emotion: "自分の弱さや無責任さを認め、変わりたいと本気で思う。（ラーニング・パートナーシップ）" },
                        { time: 4.0, stage: 2.2, event: "メンバーに謝罪し、本音で向き合う", emotion: "断られるかもしれないと怖いが、逃げないと決める。信頼回復を試みる。" },
                        { time: 4.05, stage: 2.1, event: "謝罪後の気まずい期間を乗り越える", emotion: "すぐには関係が修復されず、忍耐が必要だと学ぶ。" },
                        { time: 4.1, stage: 2.5, event: "チームが再始動し、これまでにない充実感を得る", emotion: "大変だが、チームが一つになっていくことに喜びを感じる。" },
                        { time: 4.2, stage: 2.4, event: "プロジェクト進行中の小さな挫折を経験", emotion: "完璧にはいかないが、諦めずに継続することの大切さを学ぶ。" },
                        { time: 4.3, stage: 2.8, event: "ベンチャー企業のインターンで「ここだ！」と直感", emotion: "社員たちが本気で議論する姿に惹かれ、自分の価値観と重なる。" },
                        { time: 4.35, stage: 2.7, event: "親にベンチャー就職の相談をして反対される", emotion: "期待していた理解が得られず、一時的に迷いが生じる。" },
                        { time: 4.4, stage: 3.0, event: "親を説得し、ベンチャー企業への就職を決意", emotion: "親の期待よりも自分の内的な確信を優先し、熱意をもって説明する。" },
                        { time: 4.8, stage: 3.0, event: "卒論執筆で苦戦しながらも、最後まで取り組む", emotion: "簡単ではないが、投げ出さずに完成させる意志を持ち続ける。" },
                        { time: 4.9, stage: 3.1, event: "卒業論文を完成させ、大きな達成感を得る", emotion: "4年間での自分の成長を実感し、「ノリだけの自分」から成長した物語を肯定的に受け止める。" },
                        { time: 5.1, stage: 3.2, event: "卒業。多くの人への感謝と共に、新しいステージへ", emotion: "自分の成長は他者との関わりの中にあったと理解し、誠実に関われるようになる。" }
                    ],
                    stagnation: [
                        { time: 1.2, stage: 1.0, event: "入学、サークルで人気者に", emotion: "「大学、ちょろいな！」と楽観的。友達がたくさんできて楽しい。" },
                        { time: 1.4, stage: 1.0, event: "バイト先で将来について聞かれるが、すぐに忘れる", emotion: "深く考えたくない。今が楽しければそれでいい。" },
                        { time: 2.0, stage: 0.9, event: "授業についていけず、友人に頼ってばかり", emotion: "自分で解決する努力をせず、依存的になっている自分に薄々気づく。" },
                        { time: 2.5, stage: 1.1, event: "友人の助けで試験をクリアし、安心する", emotion: "「何とかなった」と、根本的な問題に向き合わない。" },
                        { time: 2.7, stage: 1.0, event: "友人たちと「楽単」と評判のゼミを選ぶ", emotion: "「ゼミは楽なのが一番」と、学問的興味ではなく安楽さを基準にする。" },
                        { time: 3.2, stage: 1.2, event: "周りが就活を意識し始め、少し焦る", emotion: "「自分も何かしないと」と思うが、具体的な行動は起こさない。" },
                        { time: 3.4, stage: 1.0, event: "場の雰囲気でゼミのリーダーを引き受ける", emotion: "「まあ、いっか」と深く考えずに引き受ける。他者からの期待に流される。" },
                        { time: 3.6, stage: 1.1, event: "リーダーの仕事が思ったより大変で困惑", emotion: "責任の重さに気づくが、「みんなで何とかなるだろう」と楽観視。" },
                        { time: 3.7, stage: 1.0, event: "【分岐点】プロジェクトが停滞し、雰囲気が険悪に", emotion: "「なんか雰囲気悪いな」と問題から目をそらし、責任から逃げようとする。" },
                        { time: 3.75, stage: 0.8, event: "チームの状況が悪化し、逃げ出したくなる", emotion: "「こんなはずじゃなかった」と現実逃避に走る。" },
                        { time: 3.8, stage: 0.9, event: "メンバーから真剣に問われ、他責にする", emotion: "「俺一人のせいじゃないだろ」と心の中で反発。自己防衛に走る。" },
                        { time: 3.85, stage: 0.7, event: "孤立感が深まり、自己嫌悪に陥る", emotion: "みんなから責められていると感じ、被害者意識を強める。" },
                        { time: 3.9, stage: 0.8, event: "リーダーの役割を放棄し、ゼミで孤立する", emotion: "「あんな奴らとやってられない」と開き直り、自分の弱さと向き合うことから逃げる。" },
                        { time: 4.0, stage: 0.8, event: "プロジェクトが空中分解。嫌悪感だけが残る", emotion: "「俺のせいじゃない」と最後まで思い、失敗を内省せず他者への不信感を募らせる。" },
                        { time: 4.1, stage: 0.9, event: "友人たちと遊んで失敗を忘れようとする", emotion: "辛い現実から逃げるように、一時的な楽しさを求める。" },
                        { time: 4.2, stage: 0.7, event: "就活もうまくいかず、自己否定に陥る", emotion: "「どうせ俺なんて」とやる気を失い、面接官を敵のように感じる。" },
                        { time: 4.25, stage: 0.9, event: "友人が内定を取る話を聞いて一時的に焦る", emotion: "「俺も頑張らないと」と思うが、すぐに諦めモードに戻る。" },
                        { time: 4.3, stage: 0.7, event: "投げやりな気持ちで、雰囲気がゆるそうな会社に就職を決める", emotion: "「どこでもいいや」と、辛い現実からの避難場所のように感じる。" },
                        { time: 4.5, stage: 0.8, event: "残りの学生生活を遊びに費やす", emotion: "ゼミの失敗を忘れるかのように、刹那的な楽しさを求め、内省から逃避する。" },
                        { time: 4.7, stage: 0.7, event: "将来への不安が頭をよぎるが、すぐに打ち消す", emotion: "考えても仕方ないと自分に言い聞かせ、現実逃避を続ける。" },
                        { time: 5.1, stage: 0.9, event: "卒業。気まずさと後悔の中で学生生活を終える", emotion: "4年間で何が残ったのか分からず、失敗した人間関係の記憶だけが残る。" }
                    ]
                }
            },
            sato: {
                name: "佐藤花",
                description: "真面目で優しく、他者への配慮が強い。一方で、親の期待と自分の意志の間で葛藤を抱えている。",
                color: "#ec4899",
                detailJourney: {
                    growth: [
                        { time: "1年4月", event: "入学。親の期待通り、地元の国立大学の経済学部に進学。新しい環境に緊張する。", emotion: "親の期待に応えられてホッとしている。友達作りに不安もあるが、頑張ろうと思う。" },
                        { time: "1年6月", event: "サークルには入らず、勉強とバイトの両立を始める。家庭教師のバイトを選ぶ。", emotion: "忙しいが充実している。教えることで「人の役に立っている」実感を得る。" },
                        { time: "1年10月", event: "家庭教師の生徒が「先生のおかげで分かるようになった」と喜んでくれる。", emotion: "初めて感じる「誰かの役に立てた」という達成感。教育に興味を持ち始める。" },
                        { time: "1年12月", event: "期末試験で良い成績を取り、親に褒められる。帰省時に親戚にも自慢される。", emotion: "親の期待に応えられて嬉しい反面、プレッシャーも感じる。" },
                        { time: "2年4月", event: "2年生になり、より専門的な授業が始まる。法学部の友人と話す機会が増える。", emotion: "学問の幅の広さを知り、自分の興味について考え始める。" },
                        { time: "2年6月", event: "「社会保障論」の授業で、子どもの貧困について学び、深く心を動かされる。", emotion: "社会の不平等に憤りを感じ、何かできることはないかと真剣に考える。" },
                        { time: "2年9月", event: "ゼミ選択について、親は「公務員に有利なゼミ」を勧めるが、自分は福祉系に興味を持つ。", emotion: "親の期待と自分の関心のずれを初めて明確に感じる。悩みながらも、まだ親の意見を優先しがち。" },
                        { time: "2年11月", event: "福祉系ボランティア団体の説明会に参加。活動内容に強く惹かれる。", emotion: "「これだ！」という直感を感じるが、親に言い出せずにいる。" },
                        { time: "2年1月", event: "ボランティア団体のイベントに参加。社会的養護下の子どもたちと接する機会を得る。", emotion: "子どもたちの笑顔を見て、この分野で働きたいという気持ちが確信に変わる。" },
                        { time: "2年3月", event: "春休み、帰省時に恐る恐る親に「福祉の仕事に興味がある」と話してみる。", emotion: "親の反対を予想していたが、意外にも「人の役に立つなら」と理解を示してくれて驚く。" },
                        { time: "3年4月", event: "3年生になり、就職活動を本格的に意識し始める。周りの友人がインターンシップに行き始め、焦る。", emotion: "「自分も何かしないと」と強い焦燥感に駆られるが、バイトが忙しく時間が取れない。" },
                        { time: "3年5月", event: "親から「地元の市役所が一番いい」と頻繁に言われる。公務員試験の参考書を送ってくる。", emotion: "親の期待が重荷。ありがたいと思う反面、反発したい気持ちも芽生える。" },
                        { time: "3年6月", event: "ゼミのテーマを、自分の関心（社会的養護下の子ども支援）に基づいて初めて自分で選択する。", emotion: "先生に理由を聞かれ、戸惑いながらも自分の興味について話せ、少し嬉しかった。" },
                        { time: "3年9月", event: "後期開始。ゼミ活動が本格化。同じテーマに関心を持つ仲間と議論するのが楽しい。", emotion: "バイトや勉強の疲れが、ゼミに行くと癒される。自分の居場所だと感じる。" },
                        { time: "3年10月", event: "大学のキャリアセンターで、NPOへの就職について相談する。", emotion: "不安定さや給与面の現実を知り、落ち込むが、同時に選択肢も知ることができた。" },
                        { time: "3年12月", event: "ゼミの仲間と、関心のあるNPOのイベントにボランティアとして参加する。", emotion: "活き活きと働く職員の姿を見て、改めて「ここで働きたい」と強く思う。" },
                        { time: "4年4月", event: "地元の市役所から内々定の連絡が来る。親は大喜びする。", emotion: "安心する気持ちと、自分の夢を諦めなければならないのかという絶望感。", isTurningPoint: true },
                        { time: "4年5月", event: "NPOの採用選考が進む。有期契約職員としての募集だが、挑戦したい気持ちが抑えられない。", emotion: "市役所を断るのが怖い。でも、ここで諦めたら一生後悔すると感じる。" },
                        { time: "4年6月", event: "親に「市役所を辞退して、東京のNPOに行きたい」と告げる。案の定、猛反対される。", emotion: "「親不孝者」と言われ、深く傷つく。しかし、自分の気持ちは揺るがない。" },
                        { time: "4年7月", event: "NPOから採用通知。市役所に辞退の連絡を入れる。", emotion: "大きな不安と、それを上回るほどの決意と希望。自分の人生が始まった感覚。" },
                        { time: "4年1月", event: "卒業論文提出。ゼミでの学びの集大成として、満足のいくものが書けた。", emotion: "達成感でいっぱい。" },
                        { time: "4年3月", event: "卒業式。親も来てくれる。「あなたの人生だから」と、完全ではないが、少し認めてくれる。", emotion: "親の言葉に涙が出る。感謝と、これから頑張ろうという気持ちを新たにする。" }
                    ],
                    stagnation: [
                        { time: "1年4月", event: "入学。親の期待通り、地元の国立大学の経済学部に進学。新しい環境に緊張する。", emotion: "親の期待に応えられてホッとしている。自分で選んだという実感はない。" },
                        { time: "1年6月", event: "サークルには入らず、勉強とバイトの両立を始める。親が勧める塾講師のバイトを選ぶ。", emotion: "親の言う通りにしていれば間違いないと思う。自分で考える必要がない楽さを感じる。" },
                        { time: "1年10月", event: "勉強とバイトの毎日で、特に疑問を持つことなく過ごす。", emotion: "このまま流されて生きていけばいいと思っている。特別な目標は持たない。" },
                        { time: "1年12月", event: "期末試験で良い成績を取り、親に褒められる。帰省時に親戚にも自慢される。", emotion: "親の期待に応えられて安心する。自分の価値は成績で決まると思い込む。" },
                        { time: "2年4月", event: "2年生になり、より専門的な授業が始まる。特に興味は持てないが、単位取得に集中する。", emotion: "授業は退屈だが、卒業のために必要だと割り切る。" },
                        { time: "2年6月", event: "「社会保障論」の授業で、子どもの貧困について学ぶが、「可哀想だな」程度にしか感じない。", emotion: "社会問題は遠い世界の話だと感じる。自分には関係ないと思う。" },
                        { time: "2年9月", event: "ゼミ選択について、親が勧める「公務員に有利なゼミ」を素直に選ぶ。", emotion: "親の意見が正しいと信じて疑わない。自分で調べることもしない。" },
                        { time: "2年11月", event: "就職のことを考え始め、親から「公務員が一番安定している」と繰り返し言われる。", emotion: "安定が一番大切だと納得する。リスクを取ることは考えない。" },
                        { time: "2年1月", event: "友人たちが様々な活動をしているが、自分は勉強とバイトだけの単調な生活を続ける。", emotion: "他の人の活動を見ても「大変そう」としか思わない。" },
                        { time: "2年3月", event: "春休み、帰省時に親から改めて「公務員になってほしい」と言われ、素直に頷く。", emotion: "親の期待に応えることが自分の幸せだと信じている。" },
                        { time: "3年4月", event: "3年生になり、就職活動を本格的に意識し始める。周りの友人がインターンシップに行き始め、焦る。", emotion: "「自分も何かしないと」と強い焦燥感に駆られるが、バイトが忙しく時間が取れない。" },
                        { time: "3年1月", event: "公務員試験の勉強に集中するため、NPOへの就職活動は諦める。", emotion: "「仕方ない」「これが現実」と自分に言い聞かせる。" },
                        { time: "4年4月", event: "地元の市役所から内々定の連絡が来る。親は大喜びする。", emotion: "心の底から喜べない自分に気づくが、親が喜んでいるのを見て、これで良かったのだと思うようにする。", isTurningPoint: true },
                        { time: "4年5月", event: "関心のあったNPOのサイトを見るのをやめる。", emotion: "見ると未練が残るから。辛い気持ちになる。" },
                        { time: "4年6月", event: "就職活動を終え、周りの友人に「市役所に決まった」と報告する。", emotion: "「すごいね」「安定していていいね」と言われ、優越感と、空しさを同時に感じる。" },
                        { time: "4年7月-12月", event: "卒業までの残りの日々を、卒業に必要な単位取得とバイトだけに費やす。", emotion: "心に穴が空いたような、無気力な日々。" },
                        { time: "4年1月", event: "卒業論文を提出。最低限の要件を満たすためだけに書いた。達成感はない。", emotion: "早く社会人になって、忙しくなって、色々考えなくて済むようになりたい、とすら思う。" },
                        { time: "4年3月", event: "卒業式。特に感慨もなく、事務的に一日を終える。", emotion: "「これでよかったんだ」と、何度も自分に言い聞かせる。" }
                    ]
                },
                selfAuthorshipJourney: {
                    growth: [
                        { time: 1.2, stage: 1.0, event: "入学、親の期待通り経済学部へ", emotion: "親の期待に応えられてホッとしている。自分の道はこれで正しいと信じる。" },
                        { time: 1.4, stage: 1.1, event: "家庭教師バイトで初めて「人の役に立つ」実感", emotion: "生徒の成長を見て、教育への関心が芽生える。自分の可能性を少し感じる。" },
                        { time: 1.6, stage: 1.0, event: "バイトが忙しく、友人との時間が減る", emotion: "少し孤独を感じるが、責任感で乗り切ろうとする。" },
                        { time: 1.8, stage: 1.2, event: "期末試験で好成績、親に褒められる", emotion: "親の期待に応えられる安心感と、少しのプレッシャーを感じる。" },
                        { time: 2.0, stage: 1.1, event: "2年生になり、専門授業の難しさに戸惑う", emotion: "これまでの暗記中心の勉強だけでは通用しないことに気づく。" },
                        { time: 2.4, stage: 1.3, event: "社会保障論で子どもの貧困について学ぶ", emotion: "社会問題への関心が芽生える。何かできることがあるのではと考え始める。" },
                        { time: 2.6, stage: 1.2, event: "親から「勉強に集中しなさい」と言われ迷う", emotion: "新しい関心と親の期待の間で板挟みになる複雑な気持ち。" },
                        { time: 2.7, stage: 1.4, event: "福祉系ボランティア説明会に参加", emotion: "「これだ！」という直感を感じるが、親に言い出せない複雑な気持ち。" },
                        { time: 2.9, stage: 1.5, event: "ボランティアで社会的養護下の子どもたちと接する", emotion: "子どもたちの笑顔に心を打たれ、この分野で働きたいという確信を得る。" },
                        { time: 3.0, stage: 1.4, event: "親との価値観の違いに悩む期間", emotion: "自分の気持ちと親の期待の間で揺れ動く日々が続く。" },
                        { time: 3.1, stage: 1.6, event: "恐る恐る親に福祉への興味を打ち明ける", emotion: "親の理解を得られて驚き、自分の気持ちを大切にしてもいいのかもと思う。" },
                        { time: 3.2, stage: 1.2, event: "友人がインターンに行き始め、焦る", emotion: "「自分も何かしないと」と強い焦燥感。バイトが忙しく時間が取れない。" },
                        { time: 3.3, stage: 1.3, event: "時間管理に苦労しながらも、優先順位を考える", emotion: "忙しさの中で、本当に大切なことは何かを考え始める。" },
                        { time: 3.4, stage: 1.4, event: "ゼミのテーマを自分の関心で選択", emotion: "先生に興味について話せ、少し嬉しかった。自分の関心を肯定される経験。" },
                        { time: 3.6, stage: 1.5, event: "ゼミ選択後の不安な期間", emotion: "本当にこの選択で良かったのか、少し不安になる。" },
                        { time: 3.7, stage: 1.6, event: "ゼミで同じ関心を持つ仲間と議論する", emotion: "自分の居場所だと感じる。知的な協働関係が自己肯定感を育む。" },
                        { time: 3.8, stage: 1.8, event: "キャリアセンターでNPO就職について相談", emotion: "現実を知り落ち込むが、選択肢も知れた。（ラーニング・パートナーシップ）" },
                        { time: 3.85, stage: 1.6, event: "厳しい現実に一時的に心が折れそうになる", emotion: "理想と現実のギャップに苦しみ、諦めようかと思う瞬間もある。" },
                        { time: 3.9, stage: 2.0, event: "NPOのイベントにボランティア参加", emotion: "「ここで働きたい」と強く思う。自分の「やりたい」が確信に変わる。" },
                        { time: 4.0, stage: 1.9, event: "就活準備で現実的な不安が増す", emotion: "NPOの不安定さや親の反対を考えると、迷いが生じる。" },
                        { time: 4.2, stage: 1.9, event: "【分岐点】地元の市役所から内々定", emotion: "安心と、夢を諦めるのかという絶望感で引き裂かれそうになる。" },
                        { time: 4.3, stage: 2.2, event: "内々定後の葛藤期間を経て、自分の気持ちを再確認", emotion: "安全な道と夢の道の間で苦悩するが、後悔したくない気持ちが勝る。" },
                        { time: 4.4, stage: 2.5, event: "親にNPO行きを告げ、猛反対される", emotion: "深く傷つくが、自分の気持ちは揺るがない。「自分の人生の著者」になる覚悟が決まる。" },
                        { time: 4.45, stage: 2.3, event: "親との関係悪化に苦しむ", emotion: "親を悲しませてしまった罪悪感と自分の決意の間で苦しむ。" },
                        { time: 4.5, stage: 3.0, event: "NPOから採用通知。市役所を辞退", emotion: "大きな不安と、それを上回るほどの決意と希望。自分の人生が始まった感覚。" },
                        { time: 4.7, stage: 2.9, event: "卒論執筆で忙しい中、将来への不安も感じる", emotion: "選択した道への責任の重さを感じ、しっかりやらなければという気持ち。" },
                        { time: 4.9, stage: 3.1, event: "卒業論文を満足のいく形で提出", emotion: "達成感でいっぱい。4年間の学びと経験を肯定的に意味づける。" },
                        { time: 5.1, stage: 3.2, event: "卒業式。親も少し認めてくれる", emotion: "親の言葉に涙が出る。感謝と、これから頑張ろうという気持ちを新たにする。" }
                    ],
                    stagnation: [
                        { time: 1.2, stage: 1.0, event: "入学、親の期待通り経済学部へ", emotion: "親の期待に応えられて安心。自分で選んだという実感はない。" },
                        { time: 1.4, stage: 1.0, event: "親の勧める塾講師バイトを始める", emotion: "親の言う通りにしていれば間違いない。自分で考える必要がない楽さ。" },
                        { time: 1.6, stage: 0.9, event: "バイトで思うように教えられず自信を失う", emotion: "期待されているのに応えられない自分に失望する。" },
                        { time: 1.8, stage: 1.0, event: "好成績で親に褒められ、安心する", emotion: "自分の価値は成績で決まると思い込む。" },
                        { time: 2.2, stage: 1.1, event: "友人が社会問題に関心を持つ話を聞いて少し刺激される", emotion: "「そういう考え方もあるのか」と思うが、自分には関係ないと思い直す。" },
                        { time: 2.4, stage: 1.0, event: "社会保障論を「可哀想だな」程度にしか感じない", emotion: "社会問題は遠い世界の話。自分には関係ないと思う。" },
                        { time: 2.6, stage: 0.9, event: "ボランティア説明会のポスターを見るが、参加しない", emotion: "興味はあるが、親に何か言われそうで行かない。" },
                        { time: 2.7, stage: 1.0, event: "親の勧める「公務員に有利なゼミ」を素直に選ぶ", emotion: "親の意見が正しいと信じて疑わない。自分で調べることもしない。" },
                        { time: 2.9, stage: 1.0, event: "公務員が一番安定していると納得する", emotion: "安定が一番大切。リスクを取ることは考えない。" },
                        { time: 3.1, stage: 1.0, event: "親の「公務員になってほしい」に素直に頷く", emotion: "親の期待に応えることが自分の幸せだと信じている。" },
                        { time: 3.2, stage: 1.2, event: "友人がインターンに行き始め、焦る", emotion: "「自分も何かしないと」と焦るが、NPOは無理な夢だと諦めの気持ちが強い。" },
                        { time: 3.4, stage: 1.1, event: "公務員試験の勉強を始めるが、モチベーションが上がらない", emotion: "やらなければならないことだが、心から楽しいとは思えない。" },
                        { time: 3.6, stage: 1.3, event: "友人のNPO活動の話を聞いて一瞬憧れる", emotion: "「いいなあ」と思うが、「でも現実的じゃない」とすぐに諦める。" },
                        { time: 3.8, stage: 1.0, event: "親に「NPOって大変そうね」と言われ、関心を封印", emotion: "親の意見に同調し、自分の気持ちにふたをする。" },
                        { time: 4.0, stage: 1.1, event: "公務員試験に集中するため、NPO活動を諦める", emotion: "「仕方ない」「これが現実」と自分に言い聞かせ、やりたい気持ちに蓋をする。" },
                        { time: 4.15, stage: 0.9, event: "試験勉強が辛く、何のためにやっているのか分からなくなる", emotion: "義務感だけで続けている自分に虚しさを感じる。" },
                        { time: 4.2, stage: 1.2, event: "【分岐点】地元の市役所から内々定", emotion: "心の底から喜べないが、親が喜んでいるのを見て、これで良かったのだと思うようにする。" },
                        { time: 4.3, stage: 1.1, event: "NPOのサイトを見るのをやめる", emotion: "見ると未練が残るから。自分の本当の気持ちと向き合うことから逃げる。" },
                        { time: 4.4, stage: 1.2, event: "友人に市役所就職を報告し、称賛される", emotion: "「すごいね」と言われ、優越感と、空しさを同時に感じる。" },
                        { time: 4.6, stage: 1.0, event: "卒業までの日々をただ消化するように過ごす", emotion: "目標がなく、ただ時間が過ぎるのを待っている感覚。" },
                        { time: 4.7, stage: 1.0, event: "卒業までの日々を無気力に過ごす", emotion: "心に穴が空いたような、無気力な日々。学びへの意欲を失う。" },
                        { time: 4.9, stage: 0.9, event: "卒業論文を最低限の要件で提出", emotion: "達成感はない。早く色々考えなくて済むようになりたい、とすら思う。" },
                        { time: 5.1, stage: 0.9, event: "卒業式。特に感慨なく終える", emotion: "「これでよかったんだ」と、何度も自分に言い聞かせる。" }
                    ]
                }
            },
            takahashi: {
                name: "高橋あい",
                description: "無難を好む「普通」の学生。特別な情熱はないが、流されやすい分、出会いによって変化する可能性を秘めている。",
                color: "#f59e0b",
                detailJourney: {
                    growth: [
                        { time: "1年4月", event: "入学。法学部は「就職に強そう」という理由で選択。サークルとバイトを探し始める。", emotion: "大学生活への期待と、友人作りの不安。流されるままに過ごす。" },
                        { time: "1年10月", event: "バイトで担当している生徒の成績が上がり、感謝される。", emotion: "素直に嬉しい。「人の役に立つ」ことにやりがいを少し感じる。" },
                        { time: "2年2月", event: "春休み。友人からNPO法人でのインターンシップに誘われる。", emotion: "「面白そう」という理由だけで、深く考えずに参加を決める。" },
                        { time: "3年8月", event: "友人と一緒に、子どもの貧困問題に取り組むNPO法人のインターンシップに参加。", emotion: "想像以上の現実の厳しさに衝撃を受ける。自分の無知、無力さを痛感する。（強い不協和）", isTurningPoint: true },
                        { time: "3年9月", event: "インターン後も、そのNPOにボランティアとして関わり始める。", emotion: "「自分にできることは何か」を真剣に考え始める。無力感と、何かしたいという思いが交錯する。" },
                        { time: "3年10月", event: "キャリアセンターに相談し、NPO職員や法曹（弁護士）という進路について情報収集する。", emotion: "これまで考えてもみなかった選択肢に、不安と同時に強い関心を抱く。" },
                        { time: "3年12月", event: "ゼミのレポートで、インターンで扱ったテーマについて深く掘り下げる。高い評価を得る。", emotion: "自分の問題意識に基づいた学びが、評価に繋がったことに大きな自信を持つ。" },
                        { time: "4年2月", event: "法科大学院に進学した先輩に話を聞きに行く。", emotion: "現実的な厳しさを知るが、同時にやりがいも感じ、挑戦したい気持ちが強まる。" },
                        { time: "4年4月", event: "法科大学院進学という目標を定め、本格的に受験勉強を始める。就職活動は辞める。", emotion: "迷いが消え、目標に向かって集中する。清々しい気持ち。" },
                        { time: "4年11月", event: "法科大学院の合格発表。無事合格する。", emotion: "大きな安堵と達成感、喜びでいっぱいになる。" },
                        { time: "4年3月", event: "卒業式。お世話になった人たちに感謝を伝える。", emotion: "晴れやかな気持ち。未来への希望に満ちている。" }
                    ],
                    stagnation: [
                        { time: "1年4月", event: "入学。法学部は「就職に強そう」という理由で選択。サークルとバイトを探し始める。", emotion: "大学生活への期待と、友人作りの不安。流されるままに過ごす。" },
                        { time: "2年2月", event: "春休み。友人からNPO法人でのインターンシップに誘われる。", emotion: "「面白そうだし、就活のネタになりそう」という軽い気持ちで参加を決める。" },
                        { time: "3年8月", event: "NPO法人のインターンシップに参加。", emotion: "子どもたちの境遇に同情はするが、「自分には関係ない世界」だと感じる。職員の姿も「大変そう」という感想。", isTurningPoint: true },
                        { time: "3年9月", event: "インターンが終わると、ボランティアなどには参加せず、元の生活に戻る。", emotion: "「非日常」が終わり、ホッとする。" },
                        { time: "3年10月", event: "就活の面接でインターンの経験を話すが、動機や学びを深掘りされると答えに詰まる。", emotion: "うまく話せない自分に苛立つ。「なんで分かってくれないんだ」と他責にする。" },
                        { time: "3年12月", event: "周りが内定を得始め、急に焦り出す。", emotion: "「どこでもいいから内定が欲しい」という気持ちになる。" },
                        { time: "4年2月", event: "ある中小企業から内定をもらい、即座に承諾して就職活動を終える。", emotion: "「やっと終わった」という解放感でいっぱいになる。" },
                        { time: "4年11月", event: "内定者懇親会に参加するが、他の内定者と話が合わず、居心地の悪さを感じる。", emotion: "「自分、この会社でやっていけるのかな」と今更ながら不安になる。" },
                        { time: "4年3月", event: "卒業式。4年間で何が身についたか実感がないまま、社会人になることへの漠然とした不安を抱えている。", emotion: "「なんとかなる」と言い聞かせるが、自信はない。" }
                    ]
                },
                selfAuthorshipJourney: {
                    growth: [
                        { time: 1.2, stage: 1.0, event: "入学。「就職に強そう」で法学部選択", emotion: "大学生活への期待と不安。流されるままに過ごす。" },
                        { time: 1.6, stage: 1.0, event: "授業や大学生活に慣れ、平凡な日々が続く", emotion: "特に大きな問題もなく、「こんなものかな」と思う。" },
                        { time: 1.8, stage: 1.1, event: "バイトで生徒に感謝され、やりがいを感じる", emotion: "素直に嬉しい。「人の役に立つ」ことにやりがいを少し感じる。" },
                        { time: 2.2, stage: 1.0, event: "授業がマンネリ化し、特に関心を持てない", emotion: "単位を取るためという感覚で、受動的に過ごしている。" },
                        { time: 2.9, stage: 1.3, event: "友人に誘われ「面白そう」でNPOインターンに参加", emotion: "「面白そう」という直感に従って行動する。新しい世界への扉が開く。" },
                        { time: 3.2, stage: 1.2, event: "インターンまでの期間、何となく不安になる", emotion: "「本当に大丈夫かな」と少し心配になるが、友人もいるので安心。" },
                        { time: 3.6, stage: 1.8, event: "【分岐点】NPOインターンで現実の厳しさに衝撃", emotion: "自分の無知、無力さを痛感。働く大人たちの姿に心を揺さぶられる。（強い不協和）" },
                        { time: 3.65, stage: 1.5, event: "インターン中の混乱と自己嫌悪", emotion: "何もできない自分に落ち込み、逃げ出したくなる気持ちと向き合う。" },
                        { time: 3.7, stage: 2.0, event: "ボランティアを継続し、「自分にできること」を模索", emotion: "「誰かの役に立ちたい」という思いが、具体的な行動に変わる。" },
                        { time: 3.75, stage: 1.8, event: "ボランティア活動で小さな失敗を経験", emotion: "完璧にはできないが、諦めずに続けることの大切さを学ぶ。" },
                        { time: 3.8, stage: 2.2, event: "キャリアセンターに相談し、法曹などの新選択肢を知る", emotion: "不安と同時に強い関心を抱く。視野が広がる。（ラーニング・パートナーシップ）" },
                        { time: 3.9, stage: 2.4, event: "ゼミのレポートが高く評価され、自信を持つ", emotion: "自分の問題意識に基づいた学びが、他者に認められる経験をする。" },
                        { time: 4.0, stage: 2.2, event: "将来の不確実性に不安を感じる期間", emotion: "法科大学院進学への迷いと、これまでの道への疑問が交錯する。" },
                        { time: 4.1, stage: 2.4, event: "先輩に相談し、現実的な厳しさを知る", emotion: "困難さを知るが、それでも挑戦したい気持ちが強まる。" },
                        { time: 4.2, stage: 2.6, event: "親に反対されながらも、対話を諦めない", emotion: "辛いが、自分の気持ちに嘘はつけない。自分の選択に責任を持つ覚悟が芽生える。" },
                        { time: 4.25, stage: 2.4, event: "親との関係悪化に苦しむ期間", emotion: "理解されない寂しさと、それでも進みたい意志の間で揺れる。" },
                        { time: 4.3, stage: 3.0, event: "法科大学院進学を決め、就活を辞める", emotion: "迷いが消え、清々しい気持ち。自分の決断に自信と責任を感じる。" },
                        { time: 4.6, stage: 2.9, event: "受験勉強の困難さに直面", emotion: "思ったより大変だが、自分で選んだ道だからと踏ん張る。" },
                        { time: 4.9, stage: 3.1, event: "法科大学院に合格", emotion: "大きな安堵と達成感。主体的な選択と努力が結果に繋がった最高の成功体験。" },
                        { time: 5.1, stage: 3.2, event: "卒業後、法科大学院での生活がスタート", emotion: "「面白そう」から始まった道が、自分の使命に変わりつつある。" }
                    ],
                    stagnation: [
                        { time: 1.2, stage: 1.0, event: "入学。「就職に強そう」で法学部選択", emotion: "大学生活への期待と不安。流されるままに過ごす。" },
                        { time: 1.8, stage: 1.0, event: "バイトを始めるが、特に深く考えない", emotion: "周りがやっているから自分もという感覚。" },
                        { time: 2.2, stage: 0.9, event: "授業がつまらなく、サボりがちになる", emotion: "勉強への意欲を失い、何となく時間を過ごしている。" },
                        { time: 2.5, stage: 1.1, event: "友人の頑張りを見て一時的に刺激される", emotion: "「自分も何かしないと」と思うが、具体的な行動には移らない。" },
                        { time: 2.9, stage: 1.0, event: "NPOインターンに「就活のネタになりそう」と参加", emotion: "行動の動機が、内的な興味よりも外的な評価（就活で有利か）に傾いている。" },
                        { time: 3.4, stage: 1.1, event: "夏休み前、何となく過ごしてしまった自分に少し焦る", emotion: "周りと比べて遅れている気がするが、具体的な対策は取らない。" },
                        { time: 3.6, stage: 1.1, event: "【分岐点】NPOインターンを「いい経験」として消費", emotion: "「自分には関係ない世界」だと感じ、自己の在り方を問うきっかけにはしない。" },
                        { time: 3.7, stage: 1.1, event: "インターン後、元の生活に戻る", emotion: "「ガクチカ」のネタができたことに満足し、非日常が終わってホッとする。" },
                        { time: 3.8, stage: 1.0, event: "面接で経験をうまく話せず、他責にする", emotion: "自分の言葉で経験を語れず、自信を失う。" },
                        { time: 3.85, stage: 0.8, event: "就活がうまくいかず、自己嫌悪に陥る", emotion: "「どうせ自分なんて」と卑屈になり、努力を放棄しがちになる。" },
                        { time: 3.9, stage: 1.0, event: "周りが内定を得始め、焦り出す", emotion: "「どこでもいいから内定が欲しい」と、不安に突き動かされて行動する。" },
                        { time: 4.0, stage: 1.2, event: "友人の内定話を聞いて一時的に奮起する", emotion: "「自分も頑張らないと」と思うが、持続しない。" },
                        { time: 4.1, stage: 1.1, event: "中小企業から内定をもらい、即座に承諾", emotion: "「やっと終わった」という解放感。辛い状況から逃れるための選択。" },
                        { time: 4.3, stage: 1.0, event: "内定後、安心して気が抜ける", emotion: "目標がなくなり、残りの学生生活をただ消化するように過ごす。" },
                        { time: 4.5, stage: 1.0, event: "残りの学生生活を遊びに費やす", emotion: "将来について考えるのをやめ、現実から目をそらすためのモラトリアムとして過ごす。" },
                        { time: 4.7, stage: 0.8, event: "内定者懇親会で他の内定者と話が合わず不安になる", emotion: "「自分はここでやっていけるのかな」と今更ながら不安を感じる。" },
                        { time: 4.9, stage: 0.9, event: "卒論を適当に済ませ、達成感がない", emotion: "最低限やるべきことをこなしただけという感覚。" },
                        { time: 5.1, stage: 0.9, event: "卒業。漠然とした不安を抱えたまま社会人へ", emotion: "4年間で何が身についたか実感がない。「自分は何者か」という問いに答えられない。" }
                    ]
                }
            },
            uchida: {
                name: "内田慎",
                description: "内気で真面目な理系学生。周囲の期待に応えようとするが、自分の意見を持つことに苦手意識がある。",
                color: "#3b82f6",
                detailJourney: {
                    growth: [
                        { time: "1年4月", event: "入学。親の勧めで理工学部に。サークルには入らず、講義中心の生活。", emotion: "「大学はこういうものか」と受け入れる。少しの不安と、期待通りの生活への安堵。" },
                        { time: "1年6月", event: "複数の授業でレポート課題が出るが、何を書いていいか分からず戸惑う。", emotion: "自分の意見を求められることに苦手意識を持つ。「正解」が知りたいと感じる。" },
                        { time: "1年10月", event: "プログラミングの授業でエラーに苦しむ友人に、自分が理解した部分を教える。", emotion: "「ありがとう」と言われ、これまで感じたことのない嬉しさ、達成感を覚える。" },
                        { time: "2年1月", event: "親の勧めではなく、直感で選んだ「社会福祉入門」を履修登録する。", emotion: "「自分で選んでしまった」という少しの背徳感と、未知への小さな好奇心。" },
                        { time: "2年5月", event: "「社会福祉入門」で貧困問題について学ぶ。グループディスカッションで意見を求められる。", emotion: "自分の意見がなく、言葉に詰まる。居心地の悪さを感じる。（不協和）" },
                        { time: "2年11月", event: "友人Aが「〇〇先生の分野が面白そうだから」と、あまり人気のない研究室を希望していると知る。", emotion: "「人気や評判じゃなくて、自分の興味で選ぶのか…」と衝撃を受ける。" },
                        { time: "2年2月", event: "悩んだ末、少し興味のあった分野の研究室を第二希望で提出する。", emotion: "「本当にこれで良かったのか」という不安と、「自分で決めた」というかすかな手応え。" },
                        { time: "3年9月", event: "親の勧める大手メーカーのインターンシップに参加。", emotion: "有名企業で働くことに高揚感を感じるが、仕事内容にはあまり興味が持てない。" },
                        { time: "3年10月", event: "友人に誘われ、技術に惹かれていた中小企業のインターンに参加。", emotion: "社員の情熱や、参加者にも主体性を求める雰囲気に圧倒される。楽しく、やりがいを感じる。", isTurningPoint: true },
                        { time: "4年6月", event: "中小企業から内定を得る。悩んだ末、大手メーカーの内定を辞退し、中小企業への就職を決意する。", emotion: "大きな不安だが、それ以上に「自分で選んだ」という清々しい気持ちと覚悟が勝る。" },
                        { time: "4年1月", event: "卒業論文提出。大きな達成感と、少しの虚脱感。", emotion: "「やりきった」という満足感。社会に出ることへの期待と不安が入り混じる。" },
                        { time: "4年3月", event: "卒業式。友人や教員、家族に感謝を伝える。", emotion: "4年間の学びと成長を実感し、晴れやかな気持ち。" }
                    ],
                    stagnation: [
                        { time: "1年4月", event: "入学。親の勧めで理工学部に。サークルには入らず、講義中心の生活。", emotion: "「大学生活はこんなものだろう」と受け入れる。親の期待通りで安心する。" },
                        { time: "1年6月", event: "レポート課題。何を書いていいか分からず、ネットで似たテーマの文章を探して参考にする。", emotion: "「正解」に近いものを探すことに必死になる。オリジナリティを求められることに苦痛を感じる。" },
                        { time: "2年5月", event: "「社会福祉入門」のグループディスカッションで意見を求められ、当たり障りのない一般論でやり過ごす。", emotion: "意見の対立が面倒で、早く終わってほしいと感じる。" },
                        { time: "2年9月", event: "研究室の情報を集め始める。一番人気で、大手への就職実績が高い研究室を第一志望に決める。", emotion: "「みんなが良いと言うなら、そこが一番良いのだろう」と単純に考える。" },
                        { time: "2年2月", event: "希望通り、一番人気の研究室に配属決定。", emotion: "「良かった、これで安心だ」と心から満足する。" },
                        { time: "3年9月", event: "親の勧める大手メーカーのインターンシップに参加。", emotion: "有名企業の一員になれたような高揚感と、強い安心感を得る。" },
                        { time: "3年10月", event: "友人に誘われ、技術に惹かれていた中小企業のインターンに参加。", emotion: "社員の情熱を見て「大変そうだな」と感じる。自由な雰囲気に戸惑い、居心地の悪さを感じる。", isTurningPoint: true },
                        { time: "4年4月", event: "親のコネで紹介された企業から内々定を得る。", emotion: "「やっと就活が終わった」と心から安堵する。大きな達成感を感じる。" },
                        { time: "4年12月", event: "内定者懇親会に参加。優秀そうな同期を見て、気後れする。", emotion: "「自分はここでやっていけるのだろうか」と強い不安を感じる。" },
                        { time: "4年3月", event: "卒業式。解放感を感じるが、将来への漠然とした不安は消えないまま。", emotion: "4年間で何が身についたか実感がない。「これでよかったのか？」という小さな声が聞こえるが、打ち消す。" }
                    ]
                },
                selfAuthorshipJourney: {
                    growth: [
                        { time: 1.2, stage: 1.0, event: "入学、親の勧めで理工学部へ", emotion: "「大学はこういうものか」と受容。期待通りの生活に安堵。" },
                        { time: 1.4, stage: 1.0, event: "レポート課題に戸惑う", emotion: "「正解」が知りたいと感じ、自分の意見を述べることに不慣れ。" },
                        { time: 1.6, stage: 0.9, event: "レポートがうまく書けず、自信を失う", emotion: "他の学生と比べて自分の能力に不安を感じる。" },
                        { time: 1.7, stage: 1.1, event: "友人にプログラミングを教え、感謝される", emotion: "初めての達成感と、誰かの役に立つ喜びを感じる。" },
                        { time: 1.9, stage: 1.0, event: "教えた後、自分にも何かできることがあると気づく", emotion: "小さな自信の芽生えを感じるが、まだ確信は持てない。" },
                        { time: 2.0, stage: 1.2, event: "直感で「社会福祉入門」を履修", emotion: "親の意向に沿わない初の選択。背徳感と好奇心。" },
                        { time: 2.1, stage: 1.1, event: "福祉の授業を履修したことを後悔する瞬間", emotion: "「無駄なことをしたかな」と迷いが生じる。" },
                        { time: 2.3, stage: 1.5, event: "GDで意見が言えず不協和を経験", emotion: "「自分は何も考えていない」と焦りを感じる。居心地が悪い。" },
                        { time: 2.35, stage: 1.3, event: "GD後の落ち込みと自己嫌悪", emotion: "何も言えなかった自分に強い劣等感を感じる。" },
                        { time: 2.4, stage: 1.6, event: "図書館職員に相談し、助けを求める", emotion: "自分の無力さを感じるが、初めて支援者に頼ることができた。" },
                        { time: 2.6, stage: 1.7, event: "短期プログラミングスクールに通う", emotion: "「やればできる」という小さな自信がつく。新しい仲間と出会う。" },
                        { time: 2.7, stage: 1.6, event: "スクールでの学習についていけない期間", emotion: "向上心はあるが、現実の厳しさに直面して一時的に挫折感を味わう。" },
                        { time: 2.8, stage: 1.8, event: "友人Aの主体的な選択に衝撃を受ける", emotion: "「自分の興味で選ぶのか…」と、判断基準が揺らぐ。" },
                        { time: 2.9, stage: 1.7, event: "自分も主体的に選択したいが、勇気が出ない", emotion: "変わりたい気持ちと、安全な道を選びたい気持ちが交錯する。" },
                        { time: 3.0, stage: 2.0, event: "自分の興味で研究室を第二希望で提出", emotion: "「自分で決めた」というかすかな手応えと不安。" },
                        { time: 3.1, stage: 1.8, event: "研究室選択後の不安な期間", emotion: "本当にこの選択で良かったのかと悩む日々が続く。" },
                        { time: 3.2, stage: 1.9, event: "研究室のレベルの高さに圧倒される", emotion: "自己不信に陥り、孤立感を深める。(後退)" },
                        { time: 3.3, stage: 2.0, event: "教員からの「君はどう思う？」という問いに窮する", emotion: "自分の問いを立てる難しさに直面。内なる声の必要性を自覚。" },
                        { time: 3.5, stage: 1.9, event: "研究に取り組むが、なかなか結果が出ない", emotion: "努力はしているが、思うように進まない焦りを感じる。" },
                        { time: 3.7, stage: 2.5, event: "【分岐点】中小企業のインターンで強いやりがいを感じる", emotion: "「こんな風に働きたい」と憧れを抱く。強い不協和を経験。" },
                        { time: 3.8, stage: 2.3, event: "インターン後の価値観の混乱期", emotion: "今まで信じてきたものと新しい価値観の間で揺れ動く。" },
                        { time: 3.9, stage: 2.6, event: "キャリアセンターで内省を促される", emotion: "安心して本音を話せる第三者の存在に、価値観が少しずつ見えてくる。" },
                        { time: 4.1, stage: 2.5, event: "親との対立を避けたい気持ちと自分の意志の間で悩む", emotion: "変わりたいが、親を悲しませたくない複雑な気持ち。" },
                        { time: 4.2, stage: 2.8, event: "親と進路で初めて本格的に対立", emotion: "罪悪感と「自分の人生を生きたい」という強い意志がせめぎ合う。" },
                        { time: 4.3, stage: 2.7, event: "対立後の気まずい関係に苦しむ", emotion: "親との関係悪化に心を痛めるが、自分の決意も曲げたくない。" },
                        { time: 4.4, stage: 3.0, event: "悩み抜いた末、中小企業への就職を決意", emotion: "「自分で選んだ」という清々しい気持ちと覚悟が勝る。" },
                        { time: 4.5, stage: 3.0, event: "卒業研究に打ち込む", emotion: "自分の研究に自信と愛着が湧き、仲間と協働する喜びを感じる。" },
                        { time: 4.7, stage: 2.9, event: "研究で壁にぶつかり、一時的に迷いが生じる", emotion: "順調に見えても、困難に直面すると不安になることがある。" },
                        { time: 4.9, stage: 3.1, event: "卒業論文を提出、親から初めて心から褒められる", emotion: "やりきった満足感。親との関係が相互尊重へと成熟する。" },
                        { time: 5.1, stage: 3.2, event: "卒業。自分の道を選び、責任を持つ自己像を確立", emotion: "4年間の成長を実感し、晴れやかな気持ちで新しいステージへ。" }
                    ],
                    stagnation: [
                        { time: 1.2, stage: 1.0, event: "入学、親の勧めで理工学部へ", emotion: "「大学はこんなものだろう」と受容。親の期待通りで安心。" },
                        { time: 1.4, stage: 1.0, event: "ネットを参考にレポートを提出", emotion: "オリジナリティを求められることに苦痛を感じ、安易な解決策に飛びつく。" },
                        { time: 1.6, stage: 1.0, event: "先輩おすすめの「楽単」を履修", emotion: "「これでいい」と自分の選択を正当化。いかに楽するかが重要。" },
                        { time: 1.8, stage: 0.9, event: "プログラミングで友人に教えるが、自分の成長には目を向けない", emotion: "「たまたま知っていただけ」と自分の能力を過小評価する。" },
                        { time: 2.1, stage: 1.0, event: "福祉の授業に興味を持つが、「役に立たない」と切り捨てる", emotion: "実用性のない学問は意味がないと考え、関心を封印する。" },
                        { time: 2.3, stage: 1.0, event: "GDで当たり障りのない一般論でやり過ごす", emotion: "意見の対立が面倒。早く終わってほしい。" },
                        { time: 2.5, stage: 0.9, event: "試験で単位を落とすが、学習方法を見直さない", emotion: "親に叱責され自己嫌悪に陥るが、原因を深く分析しない。" },
                        { time: 2.6, stage: 1.1, event: "友人の誘いでプログラミングスクールを検討するが結局行かない", emotion: "「お金の無駄だ」と合理化して、成長機会を逃す。" },
                        { time: 2.7, stage: 1.0, event: "一番人気で就職実績の高い研究室を志望", emotion: "判断基準は「他者の評価」。みんなが良いと言うから良いのだろうと考える。" },
                        { time: 2.8, stage: 1.0, event: "友人Aの主体的な選択を「自分とは違う」と捉える", emotion: "自分と向き合うことから逃げ、行動を変えるきっかけにしない。" },
                        { time: 3.0, stage: 1.0, event: "人気研究室への配属を目指すが、競争に疲れる", emotion: "周りとの比較に疲れるが、それでも「正解」を求め続ける。" },
                        { time: 3.1, stage: 1.1, event: "希望通りの人気研究室に配属され、満足する", emotion: "「正しい」選択ができたと確信。親や周囲の期待に応えられ誇らしい。" },
                        { time: 3.4, stage: 1.0, event: "研究室のハイレベルな環境に圧倒され、萎縮する", emotion: "ついていけない自分を責めるが、努力の方向性を見つけられない。" },
                        { time: 3.7, stage: 1.1, event: "大手メーカーのインターンで強い安心感を得る", emotion: "有名企業の一員になれたような高揚感。この会社に入りたいと強く思う。" },
                        { time: 3.8, stage: 1.0, event: "【分岐点】中小企業のインターンで居心地の悪さを感じる", emotion: "「自分には安定した大手が合っている」と自分の感情に蓋をする。" },
                        { time: 3.9, stage: 0.9, event: "就活で自分をアピールできず、自信を失う", emotion: "「自分には特別なものがない」と劣等感を強める。" },
                        { time: 4.1, stage: 1.0, event: "親のコネを頼りに就活を進める", emotion: "「背に腹は代えられない」と、依存的な解決策に頼る。" },
                        { time: 4.2, stage: 1.0, event: "親のコネで内々定を得て、心から安堵する", emotion: "「やっと就活が終わった」。大手内定が大学生活の成功の証だと確信する。" },
                        { time: 4.3, stage: 0.9, event: "就活を終え、燃え尽き症候群に", emotion: "「あとは卒業するだけ」。内的な目標がなく、無気力になる。" },
                        { time: 4.5, stage: 0.8, event: "卒業研究に集中できず、周りに遅れをとる", emotion: "やる気が出ず、最低限のことしかできない自分に嫌悪感を抱く。" },
                        { time: 4.8, stage: 0.8, event: "卒業が危うくなり、恐怖から研究に着手", emotion: "追いつめられた気持ち。早く終わらせたい一心。" },
                        { time: 5.0, stage: 0.9, event: "何とか卒業要件を満たすが、達成感はない", emotion: "「卒業できれば何でもいい」という気持ちで乗り切る。" },
                        { time: 5.1, stage: 0.9, event: "卒業。将来への漠然とした不安は消えないまま", emotion: "「これでよかったのか？」という小さな声を打ち消す。" }
                    ]
                }
            }
        };

        // メインアプリケーションコンポーネント
        function App() {
            const [selectedPersonas, setSelectedPersonas] = useState(['nishimura']);
            const [viewMode, setViewMode] = useState('detail'); // 'detail' or 'selfauthorship'
            const [journeyType, setJourneyType] = useState('growth'); // 'growth' or 'stagnation' or 'both'
            const [detailComparisonMode, setDetailComparisonMode] = useState('side'); // 'side' or 'overlay'
            const [selfAuthorshipComparisonMode, setSelfAuthorshipComparisonMode] = useState('side'); // 'side' or 'overlay'
            const [filterYear, setFilterYear] = useState('all'); // 'all', '1', '2', '3', '4'
            const [showTurningPoints, setShowTurningPoints] = useState(false);
            const [dataErrors, setDataErrors] = useState([]);

            // 初期化時にデータの整合性をチェック
            useEffect(() => {
                const errors = validatePersonaData();
                setDataErrors(errors);
            }, []);

            // ペルソナの選択切り替え
            const togglePersona = (personaId) => {
                setSelectedPersonas(prev => {
                    if (prev.includes(personaId)) {
                        return prev.filter(p => p !== personaId);
                    } else if (prev.length < 4) {
                        return [...prev, personaId];
                    }
                    return prev;
                });
            };

            // ビューモードに応じたコンテンツのレンダリング
            const renderContent = () => {
                if (viewMode === 'detail') {
                    return <DetailJourneyView 
                        selectedPersonas={selectedPersonas}
                        journeyType={journeyType}
                        comparisonMode={detailComparisonMode}
                        filterYear={filterYear}
                        showTurningPoints={showTurningPoints}
                    />;
                } else {
                    return <SelfAuthorshipView 
                        selectedPersonas={selectedPersonas}
                        journeyType={journeyType}
                        comparisonMode={selfAuthorshipComparisonMode}
                    />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* ヘッダー */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            <h1 className="text-2xl font-bold text-gray-800">成長の道のりの可視化（仮想シナリオ）</h1>
                            <p className="text-sm text-gray-600 mt-1">大学生の成長と停滞の道のりを可視化</p>
                        </div>
                    </header>

                    {/* コントロールパネル */}
                    <div className="bg-white border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                            {/* ペルソナ選択 */}
                            <div className="mb-4">
                                <h3 className="text-sm font-semibold text-gray-700 mb-2">ペルソナ選択（最大4名）</h3>
                                <div className="flex flex-wrap gap-2">
                                    {Object.entries(personaData).map(([id, persona]) => (
                                        <button
                                            key={id}
                                            onClick={() => togglePersona(id)}
                                            className={`px-4 py-2 rounded-lg font-medium transition-all ${
                                                selectedPersonas.includes(id)
                                                    ? 'bg-blue-500 text-white shadow-md'
                                                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                            }`}
                                        >
                                            {persona.name}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* ビューモード切り替え */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div>
                                    <label className="text-sm font-semibold text-gray-700 block mb-2">表示モード</label>
                                    <select
                                        value={viewMode}
                                        onChange={(e) => setViewMode(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="detail">詳細ジャーニー</option>
                                        <option value="selfauthorship">セルフ・オーサーシップ</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="text-sm font-semibold text-gray-700 block mb-2">ジャーニータイプ</label>
                                    <select
                                        value={journeyType}
                                        onChange={(e) => setJourneyType(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="growth">成長ジャーニー</option>
                                        <option value="stagnation">停滞ジャーニー</option>
                                        <option value="both">両方表示</option>
                                    </select>
                                </div>

                                {selectedPersonas.length > 1 && (
                                    <div>
                                        <label className="text-sm font-semibold text-gray-700 block mb-2">比較モード</label>
                                        <select
                                            value={viewMode === 'detail' ? detailComparisonMode : selfAuthorshipComparisonMode}
                                            onChange={(e) => {
                                                if (viewMode === 'detail') {
                                                    setDetailComparisonMode(e.target.value);
                                                } else {
                                                    setSelfAuthorshipComparisonMode(e.target.value);
                                                }
                                            }}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        >
                                            <option value="side">横並び表示</option>
                                            <option value="overlay">重ね合わせ表示</option>
                                        </select>
                                    </div>
                                )}

                                {viewMode === 'detail' && (
                                    <div>
                                        <label className="text-sm font-semibold text-gray-700 block mb-2">フィルター</label>
                                        <div className="space-y-2">
                                            <select
                                                value={filterYear}
                                                onChange={(e) => setFilterYear(e.target.value)}
                                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            >
                                                <option value="all">全期間</option>
                                                <option value="1">1年目</option>
                                                <option value="2">2年目</option>
                                                <option value="3">3年目</option>
                                                <option value="4">4年目</option>
                                            </select>
                                            <label className="flex items-center space-x-2">
                                                <input
                                                    type="checkbox"
                                                    checked={showTurningPoints}
                                                    onChange={(e) => setShowTurningPoints(e.target.checked)}
                                                    className="rounded border-gray-300"
                                                />
                                                <span className="text-sm text-gray-700">分岐点のみ表示</span>
                                            </label>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* メインコンテンツ */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* データエラーの表示 */}
                        {dataErrors.length > 0 && (
                            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                                <h4 className="text-red-800 font-semibold mb-2">データの問題が検出されました:</h4>
                                <ul className="text-red-700 text-sm list-disc list-inside space-y-1">
                                    {dataErrors.map((error, index) => (
                                        <li key={index}>{error}</li>
                                    ))}
                                </ul>
                            </div>
                        )}
                        
                        {selectedPersonas.length === 0 ? (
                            <div className="text-center py-12">
                                <p className="text-gray-500">ペルソナを選択してください</p>
                            </div>
                        ) : (
                            renderContent()
                        )}
                    </main>
                </div>
            );
        };

        // 詳細ジャーニービューコンポーネント
        function DetailJourneyView({ selectedPersonas, journeyType, comparisonMode, filterYear, showTurningPoints }) {
            const filteredData = useMemo(() => {
                // 入力値の検証
                if (!selectedPersonas || !Array.isArray(selectedPersonas) || selectedPersonas.length === 0) {
                    return {};
                }
                
                try {
                    const result = {};
                    selectedPersonas.forEach(personaId => {
                        const persona = personaData[personaId];
                        if (!persona || !persona.detailJourney) {
                            console.warn(`ペルソナ ${personaId} のデータが見つかりません`);
                            return;
                        }
                        
                        result[personaId] = {
                            ...persona,
                            filteredJourneys: {}
                        };

                        ['growth', 'stagnation'].forEach(type => {
                            if (journeyType === 'both' || journeyType === type) {
                                let journey = persona.detailJourney[type];
                                
                                if (!journey || !Array.isArray(journey)) {
                                    console.warn(`ペルソナ ${personaId} の ${type} ジャーニーデータが無効です`);
                                    journey = [];
                                }
                                
                                // 年度フィルター
                                if (filterYear !== 'all') {
                                    journey = journey.filter(event => 
                                        event.time && event.time.includes(`${filterYear}年`)
                                    );
                                }
                                
                                // 分岐点フィルター
                                if (showTurningPoints) {
                                    journey = journey.filter(event => event.isTurningPoint);
                                }
                                
                                result[personaId].filteredJourneys[type] = journey;
                            }
                        });
                    });
                    return result;
                } catch (error) {
                    console.error('詳細ジャーニーデータの処理中にエラーが発生しました:', error);
                    return {};
                }
            }, [selectedPersonas, journeyType, filterYear, showTurningPoints]);

            // 重ね合わせ表示用のmergedEvents（常に計算）
            const mergedEvents = useMemo(() => {
                if (!filteredData || Object.keys(filteredData).length === 0) {
                    return [];
                }
                
                const allEvents = [];
                
                try {
                    Object.entries(filteredData).forEach(([personaId, data]) => {
                        if (!data || !data.filteredJourneys) return;
                        
                        Object.entries(data.filteredJourneys).forEach(([type, events]) => {
                            if (!events || !Array.isArray(events)) return;
                            
                            events.forEach(event => {
                                // 安全な時間形式の変換
                                let sortKey = '0000';
                                if (event.time && typeof event.time === 'string') {
                                    try {
                                        // "3年10月" -> "0310", "1年4月" -> "0104" の形式に変換
                                        const timeMatch = event.time.match(/(\d+)年(\d+)月?/);
                                        if (timeMatch) {
                                            const year = timeMatch[1].padStart(2, '0');
                                            const month = timeMatch[2].padStart(2, '0');
                                            sortKey = year + month;
                                        }
                                    } catch (error) {
                                        console.warn(`時間データの変換に失敗: ${event.time}`, error);
                                    }
                                }
                                
                                allEvents.push({
                                    ...event,
                                    personaId,
                                    personaName: data.name,
                                    personaColor: data.color,
                                    journeyType: type,
                                    sortKey
                                });
                            });
                        });
                    });
                } catch (error) {
                    console.error('mergedEvents処理中にエラーが発生しました:', error);
                    return [];
                }
                
                // 時系列でソート
                return allEvents.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
            }, [filteredData]);

            // タイムライングループ（常に計算）
            const timelineGroups = useMemo(() => {
                if (!mergedEvents || !Array.isArray(mergedEvents)) {
                    return {};
                }
                
                const groups = {};
                try {
                    mergedEvents.forEach(event => {
                        if (!event || !event.time) return;
                        
                        if (!groups[event.time]) {
                            groups[event.time] = [];
                        }
                        groups[event.time].push(event);
                    });
                } catch (error) {
                    console.error('timelineGroups処理中にエラーが発生しました:', error);
                    return {};
                }
                
                return groups;
            }, [mergedEvents]);

            // プロパティの検証（すべてのフックの後で行う）
            if (!selectedPersonas || !Array.isArray(selectedPersonas) || selectedPersonas.length === 0) {
                return <div className="p-4 text-red-600">データ読み込みエラー: ペルソナが選択されていません</div>;
            }

            if (comparisonMode === 'side') {
                return (
                    <div className={`comparison-grid comparison-grid-${selectedPersonas.length}`}>
                        {Object.entries(filteredData).map(([personaId, data]) => (
                            <div key={personaId} className="bg-white rounded-lg shadow-md p-6 overflow-auto">
                                <h3 className="text-lg font-bold text-gray-800 mb-4" style={{color: data.color}}>
                                    {data.name}
                                </h3>
                                <p className="text-sm text-gray-600 mb-4">{data.description}</p>
                                
                                {Object.entries(data.filteredJourneys).map(([type, events]) => (
                                    <div key={type} className="mb-6">
                                        <h4 className={`text-md font-semibold mb-3 ${
                                            type === 'growth' ? 'text-teal-600' : 'text-rose-600'
                                        }`}>
                                            {type === 'growth' ? '成長ジャーニー' : '停滞ジャーニー'}
                                        </h4>
                                        <div className="space-y-3">
                                            {events.map((event, index) => (
                                                <div
                                                    key={index}
                                                    className={`journey-card p-4 rounded-lg ${
                                                        type === 'growth' ? 'bg-teal-50' : 'bg-rose-50'
                                                    } ${event.isTurningPoint ? 'border-2 border-blue-500' : ''}`}
                                                >
                                                    <div className="flex items-start">
                                                        <div className="flex-shrink-0 w-20 text-sm font-medium text-gray-600">
                                                            {event.time}
                                                        </div>
                                                        <div className="flex-grow ml-4">
                                                            <p className="text-sm font-medium text-gray-800 mb-1">
                                                                {event.event}
                                                                {event.isTurningPoint && (
                                                                    <span className="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded">
                                                                        分岐点
                                                                    </span>
                                                                )}
                                                            </p>
                                                            <p className="text-sm text-gray-600 italic">
                                                                {event.emotion}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>
                );
            } else {
                // 重ね合わせ表示の実装
                return (
                    <div className="bg-white rounded-lg shadow-md p-6">
                        <h3 className="text-lg font-bold text-gray-800 mb-4">タイムライン統合ビュー</h3>
                        
                        {/* 凡例 */}
                        <div className="flex flex-wrap gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                            {selectedPersonas.map(personaId => (
                                <div key={personaId} className="flex items-center space-x-2">
                                    <div 
                                        className="w-4 h-4 rounded-full"
                                        style={{ backgroundColor: personaData[personaId].color }}
                                    />
                                    <span className="text-sm font-medium text-gray-700">
                                        {personaData[personaId].name}
                                    </span>
                                </div>
                            ))}
                            <div className="flex items-center space-x-2 ml-4">
                                <div className="w-4 h-4 bg-teal-500 rounded"/>
                                <span className="text-sm text-gray-700">成長</span>
                            </div>
                            <div className="flex items-center space-x-2">
                                <div className="w-4 h-4 bg-rose-500 rounded"/>
                                <span className="text-sm text-gray-700">停滞</span>
                            </div>
                        </div>

                        {/* タイムライン */}
                        <div className="relative">
                            {/* 中央の縦線 */}
                            <div className="absolute left-24 top-0 bottom-0 w-0.5 bg-gray-300"></div>
                            
                            {Object.entries(timelineGroups).map(([time, events], timeIndex) => (
                                <div key={time} className="relative mb-8">
                                    {/* 時間ラベル */}
                                    <div className="absolute left-0 w-20 text-right pr-3">
                                        <span className="text-sm font-bold text-gray-700 bg-white px-2 py-1 rounded">
                                            {time}
                                        </span>
                                    </div>
                                    
                                    {/* イベントカード */}
                                    <div className="ml-32 space-y-3">
                                        {events.map((event, eventIndex) => (
                                            <div
                                                key={`${event.personaId}-${eventIndex}`}
                                                className={`relative journey-card p-4 rounded-lg border-2 ${
                                                    event.journeyType === 'growth' 
                                                        ? 'bg-teal-50 border-teal-200' 
                                                        : 'bg-rose-50 border-rose-200'
                                                } ${event.isTurningPoint ? 'ring-2 ring-blue-500' : ''}`}
                                                style={{ borderLeftColor: event.personaColor, borderLeftWidth: '4px' }}
                                            >
                                                {/* 接続線 */}
                                                <div 
                                                    className="absolute w-8 h-0.5 bg-gray-300"
                                                    style={{ 
                                                        left: '-32px', 
                                                        top: '50%',
                                                        backgroundColor: event.personaColor
                                                    }}
                                                />
                                                <div 
                                                    className="absolute w-3 h-3 rounded-full bg-white border-2"
                                                    style={{ 
                                                        left: '-38px', 
                                                        top: '50%',
                                                        transform: 'translateY(-50%)',
                                                        borderColor: event.personaColor,
                                                        backgroundColor: event.personaColor
                                                    }}
                                                />
                                                
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-grow">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span 
                                                                className="text-sm font-bold"
                                                                style={{ color: event.personaColor }}
                                                            >
                                                                {event.personaName}
                                                            </span>
                                                            {event.isTurningPoint && (
                                                                <span className="text-xs bg-blue-500 text-white px-2 py-0.5 rounded">
                                                                    分岐点
                                                                </span>
                                                            )}
                                                        </div>
                                                        <p className="text-sm font-medium text-gray-800 mb-1">
                                                            {event.event}
                                                        </p>
                                                        <p className="text-sm text-gray-600 italic">
                                                            {event.emotion}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
        }

        // セルフ・オーサーシップビューコンポーネント
        function SelfAuthorshipView({ selectedPersonas, journeyType, comparisonMode }) {
            const chartRef = useRef(null);
            const tooltipRef = useRef(null);
            const [dimensions, setDimensions] = useState({ width: 0, height: 0 });

            // 横並び表示用の個別チャート描画関数
            const drawIndividualChart = (container, persona, personaIndex, width, height) => {
                const margin = {top: 30, right: 50, bottom: 60, left: 20};
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("width", width)
                    .attr("height", height);

                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // スケールの定義
                const xScale = d3.scaleLinear()
                    .domain([0.8, 5.4])
                    .range([0, chartWidth]);

                const yScale = d3.scaleLinear()
                    .domain([0.5, 3.5])
                    .range([chartHeight, 0]);

                // 背景グラデーション
                const defs = svg.append("defs");
                const stageGradient = defs.append("linearGradient")
                    .attr("id", `stage-gradient-${personaIndex}`)
                    .attr("x1", "0%")
                    .attr("y1", "100%")
                    .attr("x2", "0%")
                    .attr("y2", "0%");

                stageGradient.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", "#fef3c7")
                    .attr("stop-opacity", 0.3);

                stageGradient.append("stop")
                    .attr("offset", "50%")
                    .attr("stop-color", "#dbeafe")
                    .attr("stop-opacity", 0.3);

                stageGradient.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", "#d1fae5")
                    .attr("stop-opacity", 0.3);

                g.append("rect")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", chartWidth)
                    .attr("height", chartHeight)
                    .attr("fill", `url(#stage-gradient-${personaIndex})`);

                // 軸とグリッドの描画
                const xAxis = d3.axisBottom(xScale)
                    .ticks(4)
                    .tickFormat(d => d >= 1 && d <= 5 ? `${Math.floor(d)}年` : '');
                
                g.append("g")
                    .attr("transform", `translate(0,${chartHeight})`)
                    .call(xAxis);

                // Y軸の成長段階
                const yAxisTicks = [
                    { value: 1.0, label: "外的公式" },
                    { value: 2.0, label: "岐路" },
                    { value: 3.0, label: "セルフ・オーサーシップ" }
                ];

                yAxisTicks.forEach(tick => {
                    g.append("line")
                        .attr("class", "grid-line")
                        .attr("x1", 0)
                        .attr("x2", chartWidth)
                        .attr("y1", yScale(tick.value))
                        .attr("y2", yScale(tick.value))
                        .attr("stroke", "#e5e7eb")
                        .attr("stroke-dasharray", "3,3");

                    // 横並び表示では左側のラベルは非表示（下部の説明で補完）
                });

                // タイトル
                svg.append("text")
                    .attr("x", width / 2)
                    .attr("y", 20)
                    .attr("text-anchor", "middle")
                    .style("font-size", "14px")
                    .style("font-weight", "600")
                    .style("fill", persona.color)
                    .text(persona.name);

                // データの描画
                const line = d3.line()
                    .x(d => xScale(d.time))
                    .y(d => yScale(d.stage))
                    .curve(d3.curveMonotoneX);

                ['growth', 'stagnation'].forEach(type => {
                    if (journeyType === 'both' || journeyType === type) {
                        const data = persona.selfAuthorshipJourney[type];
                        if (!data || data.length === 0) return;

                        // ライン描画（アニメーション付き）
                        const path = g.append("path")
                            .datum(data)
                            .attr("fill", "none")
                            .attr("stroke", persona.color)
                            .attr("stroke-width", 2)
                            .attr("stroke-dasharray", type === 'stagnation' ? "5,5" : "0")
                            .attr("d", line);

                        // 線のアニメーション
                        const totalLength = path.node().getTotalLength();
                        path
                            .attr("stroke-dasharray", type === 'stagnation' ? 
                                `0 ${totalLength}` : `${totalLength} ${totalLength}`)
                            .attr("stroke-dashoffset", totalLength)
                            .transition()
                            .duration(2000)
                            .ease(d3.easeLinear)
                            .attr("stroke-dashoffset", 0)
                            .on("end", function() {
                                if (type === 'stagnation') {
                                    d3.select(this).attr("stroke-dasharray", "5,5");
                                } else {
                                    d3.select(this).attr("stroke-dasharray", "0");
                                }
                            });

                        // ポイント描画（グループ化して分岐点処理を可能にする）
                        const points = g.selectAll(`.dot-group-${type}`)
                            .data(data)
                            .enter().append("g")
                            .attr("class", `dot-group-${type}`)
                            .attr("transform", d => `translate(${xScale(d.time)}, ${yScale(d.stage)})`);

                        // 分岐点の強調
                        points.filter(d => d.event.includes("【分岐点】"))
                            .append("circle")
                            .attr("r", 0)
                            .attr("fill", "none")
                            .attr("stroke", "#3b82f6")
                            .attr("stroke-width", 2)
                            .attr("opacity", 0.8)
                            .transition()
                            .delay((d, i) => 1500 + i * 100)
                            .duration(500)
                            .attr("r", 8);

                        // ポイント本体
                        points.append("circle")
                            .attr("r", 0)
                            .attr("fill", persona.color)
                            .attr("stroke", "white")
                            .attr("stroke-width", 1)
                            .style("cursor", "pointer")
                            .on("mouseover", function(event, d) {
                                const tooltip = d3.select(tooltipRef.current);
                                d3.select(this)
                                    .transition()
                                    .duration(200)
                                    .attr("r", 6);
                                tooltip.style("opacity", 1)
                                    .html(`
                                        <div class="event">${persona.name} - ${d.event}</div>
                                        <div class="emotion">${d.emotion}</div>
                                    `)
                                    .style("left", (event.pageX + 15) + "px")
                                    .style("top", (event.pageY - 28) + "px");
                            })
                            .on("mouseout", function() {
                                d3.select(this)
                                    .transition()
                                    .duration(200)
                                    .attr("r", 4);
                                d3.select(tooltipRef.current).style("opacity", 0);
                            })
                            .transition()
                            .delay((d, i) => 1000 + i * 50)
                            .duration(500)
                            .attr("r", 4);
                    }
                });
            };

            // 画面サイズ変更の監視
            useEffect(() => {
                const handleResize = () => {
                    if (chartRef.current) {
                        const rect = chartRef.current.getBoundingClientRect();
                        setDimensions({ width: rect.width, height: rect.height });
                    }
                };

                // 初期サイズの設定
                handleResize();
                
                // リサイズイベントの監視
                window.addEventListener('resize', handleResize);
                
                return () => {
                    window.removeEventListener('resize', handleResize);
                };
            }, []);

            useEffect(() => {
                if (!chartRef.current || selectedPersonas.length === 0) return;

                // エラーハンドリング: データの存在確認
                try {
                    const hasValidData = selectedPersonas.some(personaId => {
                        const persona = personaData[personaId];
                        return persona && persona.selfAuthorshipJourney && 
                               (persona.selfAuthorshipJourney.growth?.length > 0 || 
                                persona.selfAuthorshipJourney.stagnation?.length > 0);
                    });

                    if (!hasValidData) {
                        console.warn('有効なセルフ・オーサーシップデータが見つかりません');
                        return;
                    }

                    // 既存のチャートをクリア
                    const container = d3.select(chartRef.current);
                    container.selectAll("*").remove();

                    // 横並び表示の場合
                    if (comparisonMode === 'side' && selectedPersonas.length > 1) {
                        const containerWidth = container.node().getBoundingClientRect().width;
                        const containerHeight = 400;
                        
                        // グリッドレイアウトの計算
                        const cols = selectedPersonas.length <= 2 ? selectedPersonas.length : 2;
                        const rows = Math.ceil(selectedPersonas.length / cols);
                        const chartWidth = containerWidth / cols;
                        const chartHeight = containerHeight / rows;

                        // 各ペルソナ用のコンテナを作成
                        const chartsContainer = container.append("div")
                            .style("display", "grid")
                            .style("grid-template-columns", `repeat(${cols}, 1fr)`)
                            .style("grid-gap", "10px")
                            .style("height", `${containerHeight}px`);

                        selectedPersonas.forEach((personaId, index) => {
                            const persona = personaData[personaId];
                            const chartDiv = chartsContainer.append("div")
                                .style("border", "1px solid #e5e7eb")
                                .style("border-radius", "8px")
                                .style("background", "white");

                            drawIndividualChart(chartDiv, persona, index, chartWidth - 10, chartHeight - 10);
                        });

                        return;
                    }

                    // Phase 4最終: Y軸ラベル除去でグラフ領域を最大化
                    const margin = {top: 90, right: 180, bottom: 60, left: 40};
                const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
                const height = 500 - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);

                const defs = svg.append("defs");

                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // スケールの定義
                const xScale = d3.scaleLinear()
                    .domain([0.8, 5.4])
                    .range([0, width]);

                const yScale = d3.scaleLinear()
                    .domain([0.5, 3.5])
                    .range([height, 0]);

                // ステージ別背景色の定義
                const stageColors = [
                    { range: [0.5, 1.5], color: "#fef3c7", label: "外的公式に従う局面" },
                    { range: [1.5, 2.5], color: "#dbeafe", label: "岐路の局面" },
                    { range: [2.5, 3.5], color: "#d1fae5", label: "セルフ・オーサーシップ" }
                ];

                // ステージ別背景レクト
                stageColors.forEach((stage, i) => {
                    g.append("rect")
                        .attr("x", 0)
                        .attr("y", yScale(stage.range[1]))
                        .attr("width", width)
                        .attr("height", yScale(stage.range[0]) - yScale(stage.range[1]))
                        .attr("fill", stage.color)
                        .attr("opacity", 0.15)
                        .attr("stroke", "none");
                });

                // 軸の描画
                const xAxis = d3.axisBottom(xScale)
                    .ticks(5)
                    .tickFormat(d => d >= 1 && d <= 5 ? `${Math.floor(d)}年目` : '');
                
                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(xAxis)
                    .call(g => g.select(".domain").remove())
                    .call(g => g.selectAll(".tick line").attr("stroke", "#e5e7eb"));

                g.append("text")
                    .attr("x", width / 2)
                    .attr("y", height + 50)
                    .attr("text-anchor", "middle")
                    .attr("class", "axis-label")
                    .style("font-size", "14px")
                    .style("font-weight", "500")
                    .text("時間の進行");

                // Y軸の成長段階
                const yAxisTicks = [
                    { value: 1.0, label: "外的公式に従う局面", description: "他者の期待や評価に依存" },
                    { value: 2.0, label: "岐路の局面", description: "価値観の揺らぎと内省" },
                    { value: 3.0, label: "セルフ・オーサーシップ", description: "主体的な判断と行動" }
                ];

                // Y軸のグリッド線とステージ説明（右側配置・色対応）
                yAxisTicks.forEach((tick, i) => {
                    // グリッド線
                    g.append("line")
                        .attr("class", "grid-line")
                        .attr("x1", 0)
                        .attr("x2", width)
                        .attr("y1", yScale(tick.value))
                        .attr("y2", yScale(tick.value))
                        .attr("stroke-dasharray", "3,3");

                    // ステージ説明を右側に配置・色対応
                    const labelG = g.append("g")
                        .attr("transform", `translate(${width + 10}, ${yScale(tick.value)})`);

                    // 対応する背景色を取得
                    const stageColor = stageColors.find(stage => 
                        tick.value >= stage.range[0] && tick.value <= stage.range[1]
                    )?.color || "#f9fafb";

                    labelG.append("rect")
                        .attr("x", 0)
                        .attr("y", -30)
                        .attr("width", margin.right - 20)
                        .attr("height", 60)
                        .attr("fill", stageColor)
                        .attr("fill-opacity", 0.3)
                        .attr("stroke", stageColor)
                        .attr("stroke-width", 2)
                        .attr("stroke-opacity", 0.6)
                        .attr("rx", 8)
                        .attr("filter", "drop-shadow(0 2px 4px rgba(0,0,0,0.1))");

                    // ステージ名
                    labelG.append("text")
                        .attr("x", (margin.right - 20) / 2)
                        .attr("y", -8)
                        .attr("text-anchor", "middle")
                        .style("font-size", "12px")
                        .style("font-weight", "600")
                        .style("fill", "#1f2937")
                        .text(tick.label);

                    // 説明文
                    labelG.append("text")
                        .attr("x", (margin.right - 20) / 2)
                        .attr("y", 8)
                        .attr("text-anchor", "middle")
                        .style("font-size", "10px")
                        .style("fill", "#6b7280")
                        .text(tick.description);
                });

                // 線とポイントの描画
                const line = d3.line()
                    .x(d => xScale(d.time))
                    .y(d => yScale(d.stage))
                    .curve(d3.curveMonotoneX);

                const tooltip = d3.select(tooltipRef.current);

                // クリップパス（アニメーション用）
                const clip = defs.append("clipPath")
                    .attr("id", "clip")
                    .append("rect")
                    .attr("width", 0)
                    .attr("height", height);

                // アニメーションでクリップパスを拡張
                clip.transition()
                    .duration(1500)
                    .attr("width", width);

                // データの描画
                selectedPersonas.forEach((personaId, personaIndex) => {
                    const persona = personaData[personaId];
                    const opacity = comparisonMode === 'overlay' ? 0.7 : 1;

                    ['growth', 'stagnation'].forEach(type => {
                        if (journeyType === 'both' || journeyType === type) {
                            const data = persona.selfAuthorshipJourney[type];
                            
                            // ライングループ
                            const lineG = g.append("g")
                                .attr("clip-path", "url(#clip)");

                            // ライン（影付き）
                            lineG.append("path")
                                .datum(data)
                                .attr("fill", "none")
                                .attr("stroke", persona.color)
                                .attr("stroke-width", 3)
                                .attr("opacity", opacity * 0.3)
                                .attr("filter", "blur(3px)")
                                .attr("d", line);

                            // メインライン
                            lineG.append("path")
                                .datum(data)
                                .attr("fill", "none")
                                .attr("stroke", persona.color)
                                .attr("stroke-width", 2.5)
                                .attr("opacity", opacity)
                                .attr("stroke-dasharray", type === 'stagnation' ? "5,5" : "0")
                                .attr("d", line);

                            // ポイント
                            const points = g.selectAll(`.dot-${personaId}-${type}`)
                                .data(data)
                                .enter().append("g")
                                .attr("class", `dot-${personaId}-${type}`)
                                .attr("transform", d => `translate(${xScale(d.time)}, ${yScale(d.stage)})`);

                            // 分岐点の強調
                            points.filter(d => d.event.includes("【分岐点】"))
                                .append("circle")
                                .attr("r", 0)
                                .attr("fill", "none")
                                .attr("stroke", "#3b82f6")
                                .attr("stroke-width", 2)
                                .attr("opacity", opacity * 0.8)
                                .transition()
                                .delay((d, i) => 1500 + i * 100)
                                .duration(500)
                                .attr("r", 12);

                            // ポイント本体
                            points.append("circle")
                                .attr("r", 0)
                                .attr("fill", persona.color)
                                .attr("stroke", "white")
                                .attr("stroke-width", 2)
                                .attr("opacity", opacity)
                                .style("cursor", "pointer")
                                .on("mouseover", function(event, d) {
                                    d3.select(this)
                                        .transition()
                                        .duration(200)
                                        .attr("r", 8);
                                    tooltip.style("opacity", 1);
                                })
                                .on("mousemove", function(event, d) {
                                    tooltip.html(`
                                        <div class="event">${persona.name} - ${d.event}</div>
                                        <div class="emotion">${d.emotion}</div>
                                    `)
                                    .style("left", (event.pageX + 15) + "px")
                                    .style("top", (event.pageY - 28) + "px");
                                })
                                .on("mouseout", function() {
                                    d3.select(this)
                                        .transition()
                                        .duration(200)
                                        .attr("r", 6);
                                    tooltip.style("opacity", 0);
                                })
                                .transition()
                                .delay((d, i) => 1000 + i * 50)
                                .duration(300)
                                .attr("r", 6);
                        }
                    });
                });

                // 凡例（上部配置・1行レイアウト）
                const legend = g.append("g")
                    .attr("transform", `translate(20, -60)`);

                // 凡例背景サイズを1行横並び用に計算
                const personaCount = selectedPersonas.length;
                const hasJourneyTypes = journeyType === 'both' ? 2 : 1;
                const totalLegendWidth = Math.max(
                    personaCount * 120 + 40, // ペルソナ分
                    hasJourneyTypes * 100 + 200 // ジャーニータイプ分
                );
                
                legend.append("rect")
                    .attr("x", -10)
                    .attr("y", -10)
                    .attr("width", totalLegendWidth)
                    .attr("height", 40) // 1行用の高さ
                    .attr("fill", "white")
                    .attr("stroke", "#e5e7eb")
                    .attr("stroke-width", 1)
                    .attr("rx", 6)
                    .attr("filter", "drop-shadow(0 1px 3px rgba(0,0,0,0.08))");

                // ペルソナ凡例（1行配置）
                let currentX = 10; // 開始位置
                selectedPersonas.forEach((personaId, index) => {
                    const persona = personaData[personaId];
                    const legendItem = legend.append("g")
                        .attr("transform", `translate(${currentX}, 10)`); // 1行、中央寄せ

                    legendItem.append("circle")
                        .attr("cx", 6)
                        .attr("cy", 0)
                        .attr("r", 5)
                        .attr("fill", persona.color)
                        .attr("stroke", "white")
                        .attr("stroke-width", 1);
                    
                    legendItem.append("text")
                        .attr("x", 18)
                        .attr("y", 4)
                        .text(persona.name)
                        .style("font-size", "12px")
                        .style("font-weight", "500")
                        .attr("fill", "#374151");
                    
                    // 次の要素の位置を計算
                    currentX += persona.name.length * 8 + 40; // 名前の長さに応じて調整
                });

                // ジャーニータイプ凡例（1行・右寄せ配置）
                const journeyStartX = currentX + 20; // ペルソナの後、少し間隔を空ける
                
                // 1人選択時は個別の色を使用、複数人選択時は汎用色を使用
                const legendColor = selectedPersonas.length === 1 ? 
                    personaData[selectedPersonas[0]].color : "#6b7280";
                
                // 現在の表示内容に応じて凡例を1行で調整
                if (journeyType === 'growth') {
                    // 成長ジャーニーのみの場合
                    legend.append("line")
                        .attr("x1", journeyStartX)
                        .attr("y1", 10)
                        .attr("x2", journeyStartX + 25)
                        .attr("y2", 10)
                        .attr("stroke", legendColor)
                        .attr("stroke-width", 2.5);
                    
                    legend.append("text")
                        .attr("x", journeyStartX + 30)
                        .attr("y", 14)
                        .text("成長")
                        .style("font-size", "12px")
                        .style("font-weight", "500")
                        .attr("fill", "#374151");
                        
                } else if (journeyType === 'stagnation') {
                    // 停滞ジャーニーのみの場合
                    legend.append("line")
                        .attr("x1", journeyStartX)
                        .attr("y1", 10)
                        .attr("x2", journeyStartX + 25)
                        .attr("y2", 10)
                        .attr("stroke", legendColor)
                        .attr("stroke-width", 2.5)
                        .attr("stroke-dasharray", "5,5");
                    
                    legend.append("text")
                        .attr("x", journeyStartX + 30)
                        .attr("y", 14)
                        .text("停滞")
                        .style("font-size", "12px")
                        .style("font-weight", "500")
                        .attr("fill", "#374151");
                        
                } else {
                    // 両方表示の場合（1行横並び）
                    // 成長ライン
                    legend.append("line")
                        .attr("x1", journeyStartX)
                        .attr("y1", 10)
                        .attr("x2", journeyStartX + 25)
                        .attr("y2", 10)
                        .attr("stroke", legendColor)
                        .attr("stroke-width", 2.5);
                    
                    legend.append("text")
                        .attr("x", journeyStartX + 30)
                        .attr("y", 14)
                        .text("成長")
                        .style("font-size", "12px")
                        .style("font-weight", "500")
                        .attr("fill", "#374151");

                    // 停滞ライン（横に配置）
                    const stagnationX = journeyStartX + 70;
                    legend.append("line")
                        .attr("x1", stagnationX)
                        .attr("y1", 10)
                        .attr("x2", stagnationX + 25)
                        .attr("y2", 10)
                        .attr("stroke", legendColor)
                        .attr("stroke-width", 2.5)
                        .attr("stroke-dasharray", "5,5");
                    
                    legend.append("text")
                        .attr("x", stagnationX + 30)
                        .attr("y", 14)
                        .text("停滞")
                        .style("font-size", "12px")
                        .style("font-weight", "500")
                        .attr("fill", "#374151");
                }

                } catch (error) {
                    console.error('D3.jsグラフの描画中にエラーが発生しました:', error);
                }

                // クリーンアップ関数
                return () => {
                    if (chartRef.current) {
                        d3.select(chartRef.current).selectAll("*").remove();
                    }
                };

            }, [selectedPersonas, journeyType, comparisonMode, dimensions]);

            return (
                <div className="bg-white rounded-lg shadow-md p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold text-gray-800">セルフ・オーサーシップの成長過程</h3>
                        <div className="text-sm text-gray-600">
                            {comparisonMode === 'overlay' && selectedPersonas.length > 1 && (
                                <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                                    重ね合わせ表示中
                                </span>
                            )}
                            {comparisonMode === 'side' && selectedPersonas.length > 1 && (
                                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                    横並び表示中
                                </span>
                            )}
                        </div>
                    </div>
                    <div ref={chartRef} className="w-full" style={{ 
                        minHeight: comparisonMode === 'side' && selectedPersonas.length > 1 ? '400px' : '500px' 
                    }}></div>
                    <div ref={tooltipRef} className="tooltip"></div>
                    
                    {/* 説明文 */}
                    <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 className="text-sm font-semibold text-gray-700 mb-2">グラフの見方</h4>
                        <ul className="text-sm text-gray-600 space-y-1">
                            <li>• 縦軸は成長段階を表しています</li>
                            <li>• 横軸は学年の進行を表します</li>
                            <li>• 円で囲まれた点は重要な分岐点を示しています</li>
                            <li>• 点線は停滞ジャーニー、実線は成長ジャーニーを表します</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // アプリケーションのレンダリング（React 18の新しいAPI）
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- PostMessage通信用の追加スクリプト -->
    <script>
        // 親ウィンドウとの通信機能
        window.addEventListener('message', function(event) {
            // 親からの設定変更を受信
            if (event.data.type === 'JOURNEY_CONFIG') {
                console.log('設定を受信:', event.data);
                // 必要に応じてアプリケーションの設定を更新
            }
        });
        
        // 高さ通知の制御変数
        let lastNotifiedHeight = 0;
        let notifyTimeout = null;
        let isInitialized = false;
        
        // スマートな高さ計算
        function calculateOptimalHeight() {
            const rootElement = document.getElementById('root');
            if (!rootElement) return 800; // フォールバック
            
            // 実際のコンテンツ高さを計算
            const contentHeight = rootElement.scrollHeight;
            const bodyHeight = document.body.scrollHeight;
            
            // ビューポート高さを考慮
            const viewportHeight = window.innerHeight;
            
            // 最小高さ: 800px（1ペルソナのグラフ全体が見える高さ）
            // 最大高さ: ビューポートの85%または1400px
            const minHeight = 800;
            const maxHeight = Math.min(viewportHeight * 0.85, 1400);
            
            // 実際のコンテンツに基づいて計算
            let optimalHeight = Math.max(contentHeight, bodyHeight) + 40; // パディング考慮
            
            // 範囲内に収める
            optimalHeight = Math.max(minHeight, Math.min(optimalHeight, maxHeight));
            
            console.log('高さ計算:', {
                contentHeight,
                bodyHeight,
                viewportHeight,
                optimalHeight
            });
            
            return optimalHeight;
        }
        
        // サイズ変更を親に通知（改善版）
        function notifyHeightChange() {
            if (notifyTimeout) clearTimeout(notifyTimeout);
            
            notifyTimeout = setTimeout(() => {
                const height = calculateOptimalHeight();
                
                // 高さに変化がない場合は通知しない（5px以下の変化は無視）
                if (Math.abs(height - lastNotifiedHeight) <= 5) {
                    return;
                }
                
                // 初期化前の極端な変更は無視
                if (!isInitialized && Math.abs(height - lastNotifiedHeight) > 300) {
                    console.log('初期化前の極端な高さ変更を無視:', height);
                    return;
                }
                
                lastNotifiedHeight = height;
                
                if (window.parent !== window) {
                    parent.postMessage({
                        type: 'IFRAME_HEIGHT_CHANGE',
                        height: height
                    }, '*');
                    console.log('最適化された高さを通知:', height);
                }
            }, 200); // レスポンス性向上のため200msに短縮
        }
        
        // 初期化後に高さを通知
        window.addEventListener('load', () => {
            setTimeout(() => {
                isInitialized = true;
                notifyHeightChange();
            }, 3000); // React アプリの初期化待ち
        });
        
        // リサイズ時にも高さを通知（デバウンス付き）
        window.addEventListener('resize', () => {
            if (isInitialized) {
                notifyHeightChange();
            }
        });
        
        // 内容変更時の高さ通知（制限付きMutationObserver）
        const observer = new MutationObserver((mutations) => {
            // iframe関連の変更は無視
            const relevantChanges = mutations.filter(mutation => {
                if (mutation.type === 'attributes' && 
                    (mutation.attributeName === 'height' || mutation.attributeName === 'style')) {
                    return false; // iframe の高さ変更は無視
                }
                return true;
            });
            
            if (relevantChanges.length > 0 && isInitialized) {
                notifyHeightChange();
            }
        });
        
        // DOM監視開始（React アプリのコンテンツ変更のみ監視）
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const rootElement = document.getElementById('root');
                if (rootElement) {
                    observer.observe(rootElement, {
                        childList: true,
                        subtree: true,
                        // attributes は監視しない（無限ループ防止）
                        attributes: false
                    });
                }
                isInitialized = true;
                notifyHeightChange();
            }, 4000); // React アプリの完全な初期化を待つ
        });
    </script>
</body>
</html>
